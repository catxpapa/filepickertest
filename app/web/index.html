<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•åº”ç”¨</title>
    <link rel="stylesheet" href="style.css">
    <!-- å¼•å…¥æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶ [citation](1) -->
    <script defer src="https://unpkg.com/@lazycatcloud/lzc-file-pickers@latest/dist/lzc-file-pickers.umd.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“ æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•åº”ç”¨</h1>
            <p>æ‡’çŒ«å®˜æ–¹æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶åŠŸèƒ½æµ‹è¯• - æ”¯æŒæ–‡ä»¶é€‰æ‹©ã€ç›®å½•é€‰æ‹©å’Œæ–‡ä»¶ä¿å­˜</p>
            <div id="envInfo" class="env-info">
                <p>æ­£åœ¨åŠ è½½ç¯å¢ƒä¿¡æ¯...</p>
            </div>
        </header>

        <!-- æ–‡ä»¶é€‰æ‹©å™¨ç»„ä»¶ [citation](1) -->
        <lzc-file-picker
            id="fileSelector"
            type="file"
            title="é€‰æ‹©æ–‡ä»¶"
            confirm-button-title="ç¡®è®¤é€‰æ‹©"
            breadcrumb-root-title="æ ¹ç›®å½•"
        ></lzc-file-picker>

        <lzc-file-picker
            id="dirSelector"
            type="dir"
            title="é€‰æ‹©ç›®å½•"
            confirm-button-title="ç¡®è®¤é€‰æ‹©"
            breadcrumb-root-title="æ ¹ç›®å½•"
        ></lzc-file-picker>

        <lzc-file-picker
            id="fileSaver"
            type="saveAs"
            write-file-content
            title="ä¿å­˜æ–‡ä»¶"
            confirm-button-title="ä¿å­˜"
            breadcrumb-root-title="æ ¹ç›®å½•"
        ></lzc-file-picker>

        <div class="control-panel">
            <h2>ğŸ›ï¸ æ§åˆ¶é¢æ¿</h2>
            <div class="button-group">
                <button id="openFileSelector" class="btn btn-primary">æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨</button>
                <button id="openDirSelector" class="btn btn-info">æ‰“å¼€ç›®å½•é€‰æ‹©å™¨</button>
                <button id="openFileSaver" class="btn btn-success">æ‰“å¼€æ–‡ä»¶ä¿å­˜å™¨</button>
                <button id="debugEnv" class="btn btn-warning">è°ƒè¯•ç¯å¢ƒä¿¡æ¯</button>
                <button id="testConnection" class="btn btn-secondary">æµ‹è¯•è¿æ¥</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ§ª åŠŸèƒ½æµ‹è¯•</h2>
            <div class="test-buttons">
                <button id="testFileTypes" class="btn btn-test">æµ‹è¯•æ–‡ä»¶ç±»å‹è¿‡æ»¤</button>
                <button id="testMultiSelect" class="btn btn-test">æµ‹è¯•å¤šæ–‡ä»¶é€‰æ‹©</button>
                <button id="testSaveContent" class="btn btn-test">æµ‹è¯•ä¿å­˜å†…å®¹</button>
                <button id="testNetworkDisk" class="btn btn-test">æµ‹è¯•ç½‘ç›˜é›†æˆ</button>
            </div>
        </div>

        <div class="upload-section">
            <h2>ğŸ“¤ æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h2>
            <div class="upload-area">
                <input type="file" id="fileInput" multiple accept="image/*,application/pdf,.txt,.doc,.docx,.zip">
                <button id="uploadBtn" class="btn btn-upload">ä¸Šä¼ æ–‡ä»¶</button>
                <div id="uploadProgress" class="progress-bar" style="display: none;">
                    <div class="progress-fill"></div>
                </div>
            </div>
        </div>

        <div class="file-list-section">
            <h2>ğŸ“‹ æ–‡ä»¶åˆ—è¡¨</h2>
            <button id="refreshFiles" class="btn btn-secondary">åˆ·æ–°åˆ—è¡¨</button>
            <div id="fileList" class="file-list">
                <p class="placeholder">ç‚¹å‡»åˆ·æ–°æŒ‰é’®åŠ è½½æ–‡ä»¶åˆ—è¡¨...</p>
            </div>
        </div>

        <div class="results-section">
            <h2>ğŸ“Š æ“ä½œç»“æœ</h2>
            <div id="results" class="results-container">
                <p class="placeholder">æ‰§è¡Œæ“ä½œåç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
            </div>
        </div>

        <div class="status-section">
            <h2>ğŸ“ˆ çŠ¶æ€ä¿¡æ¯</h2>
            <div id="status" class="status-container">
                <p>åº”ç”¨å·²å°±ç»ªï¼Œç­‰å¾…æ“ä½œ...</p>
            </div>
        </div>
    </div>

    <script>
        class FilePickerTester {
            constructor() {
                this.fileSelector = document.getElementById('fileSelector');
                this.dirSelector = document.getElementById('dirSelector');
                this.fileSaver = document.getElementById('fileSaver');
                this.isInitialized = false;
                this.lazycatEnv = null;
                this.apiBaseUrl = '/api';
                
                this.initApp();
            }

            // åˆå§‹åŒ–åº”ç”¨
            async initApp() {
                try {
                    // é¦–å…ˆæµ‹è¯• API è¿æ¥
                    await this.testApiConnection();
                    
                    // è·å–æ‡’çŒ«å¾®æœç¯å¢ƒä¿¡æ¯ [citation](2)
                    await this.loadLazycatEnvironment();
                    
                    this.initEventListeners();
                    this.updateStatus('æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•åº”ç”¨å·²åˆå§‹åŒ–');
                    console.log('æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•åº”ç”¨å·²åˆå§‹åŒ–');
                } catch (error) {
                    console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                    this.updateStatus(`åº”ç”¨åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                    this.useDefaultEnvironment();
                }
            }

            // æµ‹è¯• API è¿æ¥
            async testApiConnection() {
                try {
                    console.log('æµ‹è¯• API è¿æ¥...');
                    const response = await fetch(`${this.apiBaseUrl}/health`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API è¿æ¥å¤±è´¥: HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('API è¿æ¥æˆåŠŸ:', result);
                    
                    this.updateResults({
                        success: true,
                        message: 'API è¿æ¥æµ‹è¯•æˆåŠŸ',
                        details: {
                            'çŠ¶æ€': result.status,
                            'æ¶ˆæ¯': result.message,
                            'æ—¶é—´æˆ³': result.timestamp
                        }
                    });
                    
                    return true;
                } catch (error) {
                    console.error('API è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                    this.updateResults({
                        success: false,
                        message: 'API è¿æ¥æµ‹è¯•å¤±è´¥',
                        error: error.message,
                        suggestion: 'è¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸å¯åŠ¨ï¼Œè·¯ç”±é…ç½®æ˜¯å¦æ­£ç¡®'
                    });
                    throw error;
                }
            }

            // åŠ è½½æ‡’çŒ«å¾®æœç¯å¢ƒä¿¡æ¯
            async loadLazycatEnvironment() {
                try {
                    console.log('åŠ è½½ç¯å¢ƒä¿¡æ¯...');
                    const response = await fetch(`${this.apiBaseUrl}/lazycat-env`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`ç¯å¢ƒä¿¡æ¯è·å–å¤±è´¥: HTTP ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.lazycatEnv = result.environment;
                        this.displayEnvironmentInfo();
                        this.validateFilePickerDomain();
                        console.log('æ‡’çŒ«å¾®æœç¯å¢ƒä¿¡æ¯:', this.lazycatEnv);
                        
                        this.updateResults({
                            success: true,
                            message: 'ç¯å¢ƒä¿¡æ¯åŠ è½½æˆåŠŸ',
                            environment: this.lazycatEnv
                        });
                    } else {
                        throw new Error('ç¯å¢ƒä¿¡æ¯å“åº”æ ¼å¼é”™è¯¯');
                    }
                } catch (error) {
                    console.error('åŠ è½½ç¯å¢ƒä¿¡æ¯å¤±è´¥:', error);
                    this.updateResults({
                        success: false,
                        message: 'åŠ è½½ç¯å¢ƒä¿¡æ¯å¤±è´¥',
                        error: error.message,
                        suggestion: 'å°†ä½¿ç”¨é»˜è®¤ç¯å¢ƒé…ç½®'
                    });
                    
                    // ä½¿ç”¨é»˜è®¤ç¯å¢ƒä¿¡æ¯ä½œä¸ºå¤‡ç”¨
                    this.useDefaultEnvironment();
                }
            }

            // ä½¿ç”¨é»˜è®¤ç¯å¢ƒä¿¡æ¯ä½œä¸ºå¤‡ç”¨
            useDefaultEnvironment() {
                const hostname = window.location.hostname;
                const parts = hostname.split('.');
                
                if (parts.length >= 3) {
                    const boxName = parts[1]; // ä» filepickertest.kagee.heiyu.space æå– kagee
                    const domain = parts.slice(2).join('.'); // æå– heiyu.space
                    
                    this.lazycatEnv = {
                        boxName: boxName,
                        boxDomain: `${boxName}.${domain}`,
                        appDomain: hostname,
                        appId: 'cloud.lazycat.app.filepickertest',
                        filePickerDomain: `https://file.${boxName}.${domain}`
                    };
                    
                    this.displayEnvironmentInfo();
                    this.updateResults({
                        success: true,
                        message: 'ä½¿ç”¨é»˜è®¤ç¯å¢ƒé…ç½®',
                        details: 'ä»å½“å‰åŸŸåè§£æå‡ºç¯å¢ƒä¿¡æ¯',
                        environment: this.lazycatEnv
                    });
                }
            }

            // æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
            displayEnvironmentInfo() {
                const envInfoDiv = document.getElementById('envInfo');
                if (this.lazycatEnv) {
                    envInfoDiv.innerHTML = `
                        <div class="env-details">
                            <p><strong>è®¾å¤‡åç§°:</strong> ${this.lazycatEnv.boxName}</p>
                            <p><strong>è®¾å¤‡åŸŸå:</strong> ${this.lazycatEnv.boxDomain}</p>
                            <p><strong>åº”ç”¨åŸŸå:</strong> ${this.lazycatEnv.appDomain}</p>
                            <p><strong>æ–‡ä»¶é€‰æ‹©å™¨åŸŸå:</strong> ${this.lazycatEnv.filePickerDomain}</p>
                        </div>
                    `;
                } else {
                    envInfoDiv.innerHTML = '<p class="error">ç¯å¢ƒä¿¡æ¯åŠ è½½å¤±è´¥</p>';
                }
            }

            // éªŒè¯æ–‡ä»¶é€‰æ‹©å™¨åŸŸåé…ç½®
            validateFilePickerDomain() {
                if (this.lazycatEnv) {
                    const expectedDomain = this.lazycatEnv.filePickerDomain;
                    const currentDomain = window.location.origin;
                    
                    console.log('æ–‡ä»¶é€‰æ‹©å™¨é¢„æœŸåŸŸå:', expectedDomain);
                    console.log('å½“å‰åº”ç”¨åŸŸå:', currentDomain);
                    
                    this.updateResults({
                        success: true,
                        message: 'ç¯å¢ƒä¿¡æ¯éªŒè¯å®Œæˆ',
                        details: {
                            'è®¾å¤‡åç§°': this.lazycatEnv.boxName,
                            'è®¾å¤‡åŸŸå': this.lazycatEnv.boxDomain,
                            'åº”ç”¨åŸŸå': this.lazycatEnv.appDomain,
                            'æ–‡ä»¶é€‰æ‹©å™¨åŸŸå': expectedDomain,
                            'å½“å‰åŸŸå': currentDomain,
                            'åŸŸååŒ¹é…': expectedDomain.includes(this.lazycatEnv.boxName) ? 'âœ…' : 'âŒ'
                        }
                    });
                }
            }

            // åˆå§‹åŒ–æ–‡ä»¶é€‰æ‹©å™¨ [citation](1)
            initFilePicker(picker, diskPath = null) {
                try {
                    // ç­‰å¾…æ–‡ä»¶é€‰æ‹©å™¨ç»„ä»¶åŠ è½½å®Œæˆ
                    if (!picker._instance || !picker._instance.exposed) {
                        setTimeout(() => this.initFilePicker(picker, diskPath), 100);
                        return null;
                    }
                    
                    const ctx = picker._instance.exposed;
                    if (!this.isInitialized && this.lazycatEnv) {
                        // ä½¿ç”¨æ­£ç¡®çš„ç£ç›˜è·¯å¾„ï¼ŒåŸºäºæ‡’çŒ«å¾®æœç¯å¢ƒ
                        const correctDiskPath = diskPath || `/api/files/home`;
                        
                        console.log('åˆå§‹åŒ–æ–‡ä»¶é€‰æ‹©å™¨ï¼Œç£ç›˜è·¯å¾„:', correctDiskPath);
                        console.log('æ–‡ä»¶é€‰æ‹©å™¨åŸŸå:', this.lazycatEnv.filePickerDomain);
                        
                        ctx.init(correctDiskPath);
                        this.isInitialized = true;
                        this.updateStatus('æ–‡ä»¶é€‰æ‹©å™¨åˆå§‹åŒ–æˆåŠŸ');
                        
                        this.updateResults({
                            success: true,
                            message: 'æ–‡ä»¶é€‰æ‹©å™¨åˆå§‹åŒ–æˆåŠŸ',
                            details: {
                                'ç£ç›˜è·¯å¾„': correctDiskPath,
                                'æ–‡ä»¶é€‰æ‹©å™¨åŸŸå': this.lazycatEnv.filePickerDomain,
                                'è®¾å¤‡åç§°': this.lazycatEnv.boxName
                            }
                        });
                    }
                    return ctx;
                } catch (error) {
                    console.error('æ–‡ä»¶é€‰æ‹©å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                    this.updateStatus(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                    this.updateResults({
                        success: false,
                        message: 'æ–‡ä»¶é€‰æ‹©å™¨åˆå§‹åŒ–å¤±è´¥',
                        error: error.message,
                        suggestion: 'è¯·æ£€æŸ¥æ‡’çŒ«å¾®æœç¯å¢ƒå˜é‡é…ç½®å’Œæ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶åŠ è½½'
                    });
                    return null;
                }
            }

            // æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨ [citation](1)
            openFileSelector() {
                const ctx = this.initFilePicker(this.fileSelector);
                if (ctx) {
                    ctx.open();
                    this.updateStatus('æ–‡ä»¶é€‰æ‹©å™¨å·²æ‰“å¼€');
                    this.updateResults({
                        success: true,
                        message: 'æ–‡ä»¶é€‰æ‹©å™¨å·²æ‰“å¼€',
                        details: 'è¯·åœ¨å¼¹å‡ºçš„çª—å£ä¸­é€‰æ‹©æ–‡ä»¶',
                        environment: this.lazycatEnv
                    });
                }
            }

            // æ‰“å¼€ç›®å½•é€‰æ‹©å™¨ [citation](1)
            openDirSelector() {
                const ctx = this.initFilePicker(this.dirSelector);
                if (ctx) {
                    ctx.open();
                    this.updateStatus('ç›®å½•é€‰æ‹©å™¨å·²æ‰“å¼€');
                    this.updateResults({
                        success: true,
                        message: 'ç›®å½•é€‰æ‹©å™¨å·²æ‰“å¼€',
                        details: 'è¯·åœ¨å¼¹å‡ºçš„çª—å£ä¸­é€‰æ‹©ç›®å½•'
                    });
                }
            }

            // æ‰“å¼€æ–‡ä»¶ä¿å­˜å™¨ [citation](1)
            openFileSaver() {
                const ctx = this.initFilePicker(this.fileSaver);
                if (ctx) {
                    // æŒ‰ç…§æ–‡æ¡£è¦æ±‚ï¼ŒsaveAs ç±»å‹éœ€è¦å‘é€ä¿å­˜æ•°æ® [citation](1)
                    const content = JSON.stringify({
                        title: 'æµ‹è¯•æ•°æ®æ–‡ä»¶',
                        timestamp: new Date().toISOString(),
                        environment: this.lazycatEnv,
                        testData: {
                            numbers: [1, 2, 3, 4, 5],
                            text: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶',
                            boolean: true,
                            deviceName: this.lazycatEnv?.boxName || 'unknown'
                        }
                    }, null, 2);
                    
                    const extension = 'json';
                    const defaultName = `æµ‹è¯•æ–‡ä»¶-${this.lazycatEnv?.boxName || 'unknown'}-${new Date().getTime()}`;
                    
                    ctx.sendSaveAsData(content, extension, defaultName);
                    ctx.open();
                    this.updateStatus('æ–‡ä»¶ä¿å­˜å™¨å·²æ‰“å¼€ï¼Œå‡†å¤‡ä¿å­˜æµ‹è¯•å†…å®¹');
                    this.updateResults({
                        success: true,
                        message: 'æ–‡ä»¶ä¿å­˜å™¨å·²æ‰“å¼€',
                        details: 'å‡†å¤‡ä¿å­˜åŒ…å«ç¯å¢ƒä¿¡æ¯çš„JSONæµ‹è¯•æ–‡ä»¶',
                        contentPreview: content.substring(0, 200) + '...'
                    });
                }
            }

            // æµ‹è¯•æ–‡ä»¶ç±»å‹è¿‡æ»¤ [citation](1)
            testFileTypes() {
                // åˆ›å»ºä¸´æ—¶æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•ä¸åŒæ–‡ä»¶ç±»å‹
                const tempPicker = document.createElement('lzc-file-picker');
                tempPicker.setAttribute('type', 'file');
                tempPicker.setAttribute('accept', 'image/*, application/pdf, .txt');
                tempPicker.setAttribute('title', 'æ–‡ä»¶ç±»å‹è¿‡æ»¤æµ‹è¯•');
                tempPicker.style.display = 'none';
                document.body.appendChild(tempPicker);

                setTimeout(() => {
                    try {
                        const ctx = tempPicker._instance.exposed;
                        ctx.init('/api/files/home');
                        ctx.open();
                        
                        this.updateResults({
                            success: true,
                            message: 'æ–‡ä»¶ç±»å‹è¿‡æ»¤æµ‹è¯•',
                            details: 'åªå…è®¸é€‰æ‹©å›¾ç‰‡ã€PDFå’Œæ–‡æœ¬æ–‡ä»¶',
                            acceptTypes: 'image/*, application/pdf, .txt',
                            environment: this.lazycatEnv
                        });
                    } catch (error) {
                        this.updateResults({
                            success: false,
                            message: 'æ–‡ä»¶ç±»å‹è¿‡æ»¤æµ‹è¯•å¤±è´¥',
                            error: error.message
                        });
                    }
                }, 500);
            }

            // æµ‹è¯•å¤šæ–‡ä»¶é€‰æ‹©
            testMultiSelect() {
                this.updateResults({
                    success: true,
                    message: 'å¤šæ–‡ä»¶é€‰æ‹©æµ‹è¯•',
                    details: 'è¯·åœ¨æ–‡ä»¶é€‰æ‹©å™¨ä¸­æµ‹è¯•å¤šæ–‡ä»¶é€‰æ‹©åŠŸèƒ½',
                    note: 'å…·ä½“å®ç°å–å†³äºæ‡’çŒ«ç½‘ç›˜çš„æ”¯æŒç¨‹åº¦'
                });
                this.openFileSelector();
            }

            // æµ‹è¯•ä¿å­˜å†…å®¹ [citation](1)
            testSaveContent() {
                const testContent = JSON.stringify({
                    title: 'é«˜çº§æµ‹è¯•æ•°æ®',
                    timestamp: new Date().toISOString(),
                    environment: this.lazycatEnv,
                    testData: {
                        numbers: Array.from({length: 10}, (_, i) => i + 1),
                        text: 'è¿™æ˜¯ä¸€ä¸ªåŒ…å«ç¯å¢ƒä¿¡æ¯çš„é«˜çº§æµ‹è¯•æ–‡ä»¶',
                        boolean: true,
                        deviceName: this.lazycatEnv?.boxName || 'unknown',
                        features: [
                            'æ–‡ä»¶é€‰æ‹©åŠŸèƒ½',
                            'ç›®å½•é€‰æ‹©åŠŸèƒ½',
                            'æ–‡ä»¶ä¿å­˜åŠŸèƒ½',
                            'ç±»å‹è¿‡æ»¤åŠŸèƒ½'
                        ]
                    }
                }, null, 2);

                const ctx = this.initFilePicker(this.fileSaver);
                if (ctx) {
                    ctx.sendSaveAsData(testContent, 'json', 'é«˜çº§æµ‹è¯•æ•°æ®æ–‡ä»¶');
                    ctx.open();
                    
                    this.updateResults({
                        success: true,
                        message: 'ä¿å­˜å†…å®¹æµ‹è¯•',
                        details: 'å‡†å¤‡ä¿å­˜åŒ…å«å®Œæ•´ç¯å¢ƒä¿¡æ¯çš„JSONæ ¼å¼æµ‹è¯•æ•°æ®',
                        contentPreview: testContent.substring(0, 300) + '...'
                    });
                }
            }

            // æµ‹è¯•ç½‘ç›˜é›†æˆ
            testNetworkDisk() {
                this.updateResults({
                    success: true,
                    message: 'ç½‘ç›˜é›†æˆæµ‹è¯•',
                    details: 'æ–‡ä»¶é€‰æ‹©å™¨å°†è¿æ¥åˆ°æ‡’çŒ«ç½‘ç›˜ç³»ç»Ÿ',
                    features: [
                        'è®¿é—®ç½‘ç›˜æ–‡ä»¶å’Œç›®å½•',
                        'æ”¯æŒæ–‡ä»¶ä¸Šä¼ ä¸‹è½½',
                        'ç›®å½•å¯¼èˆªå’Œé¢åŒ…å±‘',
                        'æ–‡ä»¶ç±»å‹è¯†åˆ«å’Œé¢„è§ˆ'
                    ],
                    environment: this.lazycatEnv
                });
                this.openFileSelector();
            }

            // è°ƒè¯•ç¯å¢ƒä¿¡æ¯
            async debugEnvironment() {
                try {
                    // è·å–è¯¦ç»†è°ƒè¯•ä¿¡æ¯
                    const response = await fetch(`${this.apiBaseUrl}/debug`);
                    
                    if (!response.ok) {
                        throw new Error(`è°ƒè¯•æ¥å£è®¿é—®å¤±è´¥: HTTP ${response.status}`);
                    }
                    
                    const debugInfo = await response.json();
                    
                    this.updateResults({
                        success: true,
                        message: 'ç¯å¢ƒè°ƒè¯•ä¿¡æ¯',
                        details: {
                            'å½“å‰URL': window.location.href,
                            'å½“å‰åŸŸå': window.location.origin,
                            'åç«¯ç¯å¢ƒå˜é‡': debugInfo.lazycatVars || 'æœªè·å–åˆ°',
                            'æœåŠ¡å™¨æ—¶é—´': debugInfo.timestamp || 'æœªçŸ¥'
                        },
                        rawData: debugInfo
                    });
                    
                    // æ£€æŸ¥åŸŸååŒ¹é…
                    if (debugInfo.lazycatVars) {
                        const expectedFilePickerDomain = `https://file.${debugInfo.lazycatVars.LAZYCAT_BOX_NAME}.${debugInfo.lazycatVars.LAZYCAT_BOX_DOMAIN}`;
                        const currentDomain = window.location.origin;
                        
                        this.updateResults({
                            success: true,
                            message: 'åŸŸååŒ¹é…æ£€æŸ¥',
                            details: {
                                'é¢„æœŸæ–‡ä»¶é€‰æ‹©å™¨åŸŸå': expectedFilePickerDomain,
                                'å½“å‰åº”ç”¨åŸŸå': currentDomain,
                                'åŸŸååŒ¹é…': expectedFilePickerDomain.includes(debugInfo.lazycatVars.LAZYCAT_BOX_NAME) ? 'âœ…' : 'âŒ'
                            }
                        });
                    }
                    
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: 'è°ƒè¯•ä¿¡æ¯è·å–å¤±è´¥',
                        error: error.message,
                        suggestion: 'è¯·æ£€æŸ¥åç«¯è°ƒè¯•æ¥å£æ˜¯å¦å¯ç”¨'
                    });
                }
            }

            // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
            async uploadFile() {
                const fileInput = document.getElementById('fileInput');
                const files = fileInput.files;
                
                if (files.length === 0) {
                    this.updateResults({
                        success: false,
                        message: 'è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶'
                    });
                    return;
                }

                const progressBar = document.getElementById('uploadProgress');
                const progressFill = progressBar.querySelector('.progress-fill');
                progressBar.style.display = 'block';

                try {
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const formData = new FormData();
                        formData.append('file', file);

                        const response = await fetch(`${this.apiBaseUrl}/upload`, {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            this.updateResults({
                                success: true,
                                message: `æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${file.name}`,
                                details: {
                                    'åŸå§‹æ–‡ä»¶å': result.file.originalName,
                                    'æœåŠ¡å™¨æ–‡ä»¶å': result.file.filename,
                                    'æ–‡ä»¶å¤§å°': `${(result.file.size / 1024).toFixed(2)} KB`,
                                    'ä¸Šä¼ æ—¶é—´': new Date().toLocaleString()
                                }
                            });
                        } else {
                            throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
                        }

                        // æ›´æ–°è¿›åº¦
                        const progress = ((i + 1) / files.length) * 100;
                        progressFill.style.width = `${progress}%`;
                    }
                    
                    // ä¸Šä¼ å®Œæˆååˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    await this.refreshFileList();
                    
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥',
                        error: error.message
                    });
                } finally {
                    progressBar.style.display = 'none';
                    progressFill.style.width = '0%';
                    fileInput.value = '';
                }
            }

            // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
            async refreshFileList() {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/files`);
                    const result = await response.json();
                    
                    if (result.success) {
                        this.displayFileList(result.files);
                        this.updateStatus(`æ–‡ä»¶åˆ—è¡¨å·²åˆ·æ–°ï¼Œå…± ${result.files.length} ä¸ªæ–‡ä»¶`);
                    } else {
                        throw new Error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
                    }
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: 'åˆ·æ–°æ–‡ä»¶åˆ—è¡¨å¤±è´¥',
                        error: error.message
                    });
                }
            }

            // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
            displayFileList(files) {
                const fileListDiv = document.getElementById('fileList');
                
                if (files.length === 0) {
                    fileListDiv.innerHTML = '<p class="placeholder">æš‚æ— æ–‡ä»¶</p>';
                    return;
                }

                let html = '<div class="file-items">';
                files.forEach(file => {
                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <strong>${file.name}</strong>
                                <span class="file-size">${(file.size / 1024).toFixed(2)} KB</span>
                                <span class="file-date">${new Date(file.created).toLocaleString()}</span>
                            </div>
                            <div class="file-actions">
                                <button onclick="tester.downloadFile('${file.name}')" class="btn btn-sm">ä¸‹è½½</button>
                                <button onclick="tester.deleteFile('${file.name}')" class="btn btn-sm btn-danger">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                
                fileListDiv.innerHTML = html;
            }

            // ä¸‹è½½æ–‡ä»¶
            downloadFile(filename) {
                const downloadUrl = `${this.apiBaseUrl}/download/${encodeURIComponent(filename)}`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.updateResults({
                    success: true,
                    message: `å¼€å§‹ä¸‹è½½æ–‡ä»¶: ${filename}`
                });
            }

            // åˆ é™¤æ–‡ä»¶
            async deleteFile(filename) {
                if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${filename}" å—ï¼Ÿ`)) {
                    return;
                }

                try {
                    const response = await fetch(`${this.apiBaseUrl}/files/${encodeURIComponent(filename)}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.updateResults({
                            success: true,
                            message: `æ–‡ä»¶åˆ é™¤æˆåŠŸ: ${filename}`
                        });
                        await this.refreshFileList();
                    } else {
                        throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
                    }
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: 'æ–‡ä»¶åˆ é™¤å¤±è´¥',
                        error: error.message
                    });
                }
            }

            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            initEventListeners() {
                // æ§åˆ¶é¢æ¿æŒ‰é’®
                document.getElementById('openFileSelector').addEventListener('click', () => this.openFileSelector());
                document.getElementById('openDirSelector').addEventListener('click', () => this.openDirSelector());
                document.getElementById('openFileSaver').addEventListener('click', () => this.openFileSaver());
                document.getElementById('debugEnv').addEventListener('click', () => this.debugEnvironment());
                document.getElementById('testConnection').addEventListener('click', () => this.testApiConnection());

                // æµ‹è¯•åŠŸèƒ½æŒ‰é’®
                document.getElementById('testFileTypes').addEventListener('click', () => this.testFileTypes());
                document.getElementById('testMultiSelect').addEventListener('click', () => this.testMultiSelect());
                document.getElementById('testSaveContent').addEventListener('click', () => this.testSaveContent());
                document.getElementById('testNetworkDisk').addEventListener('click', () => this.testNetworkDisk());

                // æ–‡ä»¶æ“ä½œæŒ‰é’®
                document.getElementById('uploadBtn').addEventListener('click', () => this.uploadFile());
                document.getElementById('refreshFiles').addEventListener('click', () => this.refreshFileList());

                // æ–‡ä»¶é€‰æ‹©å™¨äº‹ä»¶ç›‘å¬ [citation](1)
                this.fileSelector.addEventListener('submit', (event) => {
                    const selectedFiles = event.detail[0];
                    this.updateResults({
                        success: true,
                        message: 'æ–‡ä»¶é€‰æ‹©å®Œæˆ',
                        selectedFiles: selectedFiles
                    });
                });

                this.dirSelector.addEventListener('submit', (event) => {
                    const selectedDir = event.detail[0];
                    this.updateResults({
                        success: true,
                        message: 'ç›®å½•é€‰æ‹©å®Œæˆ',
                        selectedDirectory: selectedDir
                    });
                });

                this.fileSaver.addEventListener('done', (event) => {
                    const saveResult = event.detail[0];
                    this.updateResults({
                        success: true,
                        message: 'æ–‡ä»¶ä¿å­˜å®Œæˆ',
                        saveResult: saveResult
                    });
                });
            }

            // æ›´æ–°ç»“æœæ˜¾ç¤º
            updateResults(result) {
                const resultsContainer = document.getElementById('results');
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${result.success ? 'success' : 'error'}`;
                
                let content = `<h3>${result.message}</h3>`;
                if (result.query) content += `<p><strong>æŸ¥è¯¢:</strong> ${result.query}</p>`;
                if (result.count !== undefined) content += `<p><strong>ç»“æœæ•°é‡:</strong> ${result.count}</p>`;
                if (result.expected) content += `<p><strong>é¢„æœŸ:</strong> ${result.expected}</p>`;
                if (result.details) {
                    content += '<p><strong>è¯¦ç»†ä¿¡æ¯:</strong></p><ul>';
                    Object.entries(result.details).forEach(([key, value]) => {
                        content += `<li>${key}: ${value}</li>`;
                    });
                    content += '</ul>';
                }
                if (result.error) content += `<p><strong>é”™è¯¯:</strong> ${result.error}</p>`;
                if (result.suggestion) content += `<p><strong>å»ºè®®:</strong> ${result.suggestion}</p>`;
                if (result.environment) content += `<div class="env-preview">ç¯å¢ƒä¿¡æ¯: ${JSON.stringify(result.environment, null, 2)}</div>`;
                if (result.rawData) content += `<div class="data-preview">åŸå§‹æ•°æ®: ${JSON.stringify(result.rawData, null, 2)}</div>`;
                
                resultItem.innerHTML = content;
                resultsContainer.appendChild(resultItem);
                resultsContainer.scrollTop = resultsContainer.scrollHeight;
            }

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateStatus(message) {
                const statusContainer = document.getElementById('status');
                const timestamp = new Date().toLocaleTimeString();
                statusContainer.innerHTML = `<p>[${timestamp}] ${message}</p>`;
            }
        }

        // å…¨å±€å˜é‡ï¼Œä¾›æ–‡ä»¶æ“ä½œä½¿ç”¨
        let tester;

        // ç­‰å¾…DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            tester = new FilePickerTester();
            console.log('æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•åº”ç”¨å·²å¯åŠ¨');
        });
    </script>
</body>
</html>