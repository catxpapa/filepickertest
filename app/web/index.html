<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•åº”ç”¨</title>
    <link rel="stylesheet" href="style.css">
    <!-- å¼•å…¥æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶ -->
    <script defer src="https://unpkg.com/@lazycatcloud/lzc-file-pickers@latest/dist/lzc-file-pickers.umd.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“ æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•åº”ç”¨</h1>
            <p>æ‡’çŒ«å®˜æ–¹æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶åŠŸèƒ½æµ‹è¯• - æ”¯æŒæ–‡ä»¶é€‰æ‹©ã€ç›®å½•é€‰æ‹©å’Œæ–‡ä»¶ä¿å­˜</p>
        </header>

        <!-- æ–‡ä»¶é€‰æ‹©å™¨ç»„ä»¶ -->
        <lzc-file-picker
            id="fileSelector"
            type="file"
            title="é€‰æ‹©æ–‡ä»¶"
            confirm-button-title="ç¡®è®¤é€‰æ‹©"
            breadcrumb-root-title="æ ¹ç›®å½•"
        ></lzc-file-picker>

        <lzc-file-picker
            id="dirSelector"
            type="dir"
            title="é€‰æ‹©ç›®å½•"
            confirm-button-title="ç¡®è®¤é€‰æ‹©"
            breadcrumb-root-title="æ ¹ç›®å½•"
        ></lzc-file-picker>

        <lzc-file-picker
            id="fileSaver"
            type="saveAs"
            write-file-content
            title="ä¿å­˜æ–‡ä»¶"
            confirm-button-title="ä¿å­˜"
            breadcrumb-root-title="æ ¹ç›®å½•"
        ></lzc-file-picker>

        <div class="control-panel">
            <h2>ğŸ›ï¸ æ§åˆ¶é¢æ¿</h2>
            <div class="button-group">
                <button id="openFileSelector" class="btn btn-primary">æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨</button>
                <button id="openDirSelector" class="btn btn-info">æ‰“å¼€ç›®å½•é€‰æ‹©å™¨</button>
                <button id="openFileSaver" class="btn btn-success">æ‰“å¼€æ–‡ä»¶ä¿å­˜å™¨</button>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ§ª åŠŸèƒ½æµ‹è¯•</h2>
            <div class="test-buttons">
                <button id="testFileTypes" class="btn btn-test">æµ‹è¯•æ–‡ä»¶ç±»å‹è¿‡æ»¤</button>
                <button id="testMultiSelect" class="btn btn-test">æµ‹è¯•å¤šæ–‡ä»¶é€‰æ‹©</button>
                <button id="testSaveContent" class="btn btn-test">æµ‹è¯•ä¿å­˜å†…å®¹</button>
                <button id="testNetworkDisk" class="btn btn-test">æµ‹è¯•ç½‘ç›˜é›†æˆ</button>
            </div>
        </div>

        <div class="upload-section">
            <h2>ğŸ“¤ æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h2>
            <div class="upload-area">
                <input type="file" id="fileInput" multiple accept="image/*,application/pdf,.txt,.doc,.docx,.zip">
                <button id="uploadBtn" class="btn btn-upload">ä¸Šä¼ æ–‡ä»¶</button>
                <div id="uploadProgress" class="progress-bar" style="display: none;">
                    <div class="progress-fill"></div>
                </div>
            </div>
        </div>

        <div class="file-list-section">
            <h2>ğŸ“‹ æ–‡ä»¶åˆ—è¡¨</h2>
            <button id="refreshFiles" class="btn btn-secondary">åˆ·æ–°åˆ—è¡¨</button>
            <div id="fileList" class="file-list">
                <p class="placeholder">ç‚¹å‡»åˆ·æ–°æŒ‰é’®åŠ è½½æ–‡ä»¶åˆ—è¡¨...</p>
            </div>
        </div>

        <div class="results-section">
            <h2>ğŸ“Š æ“ä½œç»“æœ</h2>
            <div id="results" class="results-container">
                <p class="placeholder">æ‰§è¡Œæ“ä½œåç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
            </div>
        </div>

        <div class="status-section">
            <h2>ğŸ“ˆ çŠ¶æ€ä¿¡æ¯</h2>
            <div id="status" class="status-container">
                <p>åº”ç”¨å·²å°±ç»ªï¼Œç­‰å¾…æ“ä½œ...</p>
            </div>
        </div>
    </div>

    <script>
        class FilePickerTester {
            constructor() {
                this.fileSelector = document.getElementById('fileSelector');
                this.dirSelector = document.getElementById('dirSelector');
                this.fileSaver = document.getElementById('fileSaver');
                this.isInitialized = false;
                
                this.initEventListeners();
                this.updateStatus('æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•åº”ç”¨å·²åˆå§‹åŒ–');
                console.log('æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•åº”ç”¨å·²åˆå§‹åŒ–');
            }

            // åˆå§‹åŒ–æ–‡ä»¶é€‰æ‹©å™¨ [citation](2)
            initFilePicker(picker, diskPath = '/api/files/home') {
                try {
                    const ctx = picker._instance.exposed;
                    if (!this.isInitialized) {
                        ctx.init(diskPath);
                        this.isInitialized = true;
                        this.updateStatus('æ–‡ä»¶é€‰æ‹©å™¨åˆå§‹åŒ–æˆåŠŸ');
                    }
                    return ctx;
                } catch (error) {
                    console.error('æ–‡ä»¶é€‰æ‹©å™¨åˆå§‹åŒ–å¤±è´¥:', error);
                    this.updateStatus(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                    return null;
                }
            }

            // æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨ [citation](2)
            openFileSelector() {
                const ctx = this.initFilePicker(this.fileSelector);
                if (ctx) {
                    ctx.open();
                    this.updateStatus('æ–‡ä»¶é€‰æ‹©å™¨å·²æ‰“å¼€');
                }
            }

            // æ‰“å¼€ç›®å½•é€‰æ‹©å™¨ [citation](2)
            openDirSelector() {
                const ctx = this.initFilePicker(this.dirSelector);
                if (ctx) {
                    ctx.open();
                    this.updateStatus('ç›®å½•é€‰æ‹©å™¨å·²æ‰“å¼€');
                }
            }

            // æ‰“å¼€æ–‡ä»¶ä¿å­˜å™¨ [citation](2)
            openFileSaver() {
                const ctx = this.initFilePicker(this.fileSaver);
                if (ctx) {
                    // æŒ‰ç…§æ–‡æ¡£è¦æ±‚ï¼ŒsaveAs ç±»å‹éœ€è¦å‘é€ä¿å­˜æ•°æ® [citation](2)
                    const content = `è¿™æ˜¯æµ‹è¯•å†…å®¹\nç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}\næµ‹è¯•æ•°æ®: ${Math.random()}`;
                    const extension = 'txt';
                    const defaultName = `æµ‹è¯•æ–‡ä»¶-${new Date().getTime()}`;
                    
                    ctx.sendSaveAsData(content, extension, defaultName);
                    ctx.open();
                    this.updateStatus('æ–‡ä»¶ä¿å­˜å™¨å·²æ‰“å¼€ï¼Œå‡†å¤‡ä¿å­˜æµ‹è¯•å†…å®¹');
                }
            }

            // æµ‹è¯•æ–‡ä»¶ç±»å‹è¿‡æ»¤ [citation](2)
            testFileTypes() {
                // åˆ›å»ºä¸´æ—¶æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•ä¸åŒæ–‡ä»¶ç±»å‹
                const tempPicker = document.createElement('lzc-file-picker');
                tempPicker.setAttribute('type', 'file');
                tempPicker.setAttribute('accept', 'image/*, application/pdf, .txt');
                tempPicker.setAttribute('title', 'æ–‡ä»¶ç±»å‹è¿‡æ»¤æµ‹è¯•');
                tempPicker.style.display = 'none';
                document.body.appendChild(tempPicker);

                setTimeout(() => {
                    const ctx = tempPicker._instance.exposed;
                    ctx.init('/api/files/home');
                    ctx.open();
                    
                    this.updateResults({
                        success: true,
                        message: 'æ–‡ä»¶ç±»å‹è¿‡æ»¤æµ‹è¯•',
                        details: 'åªå…è®¸é€‰æ‹©å›¾ç‰‡ã€PDFå’Œæ–‡æœ¬æ–‡ä»¶',
                        acceptTypes: 'image/*, application/pdf, .txt'
                    });
                }, 100);
            }

            // æµ‹è¯•å¤šæ–‡ä»¶é€‰æ‹©
            testMultiSelect() {
                // æ³¨æ„ï¼šæ ¹æ®æ–‡æ¡£ï¼Œå¤šæ–‡ä»¶é€‰æ‹©å¯èƒ½éœ€è¦ç‰¹å®šé…ç½®
                this.updateResults({
                    success: true,
                    message: 'å¤šæ–‡ä»¶é€‰æ‹©æµ‹è¯•',
                    details: 'è¯·åœ¨æ–‡ä»¶é€‰æ‹©å™¨ä¸­æµ‹è¯•å¤šæ–‡ä»¶é€‰æ‹©åŠŸèƒ½',
                    note: 'å…·ä½“å®ç°å–å†³äºæ‡’çŒ«ç½‘ç›˜çš„æ”¯æŒç¨‹åº¦'
                });
                this.openFileSelector();
            }

            // æµ‹è¯•ä¿å­˜å†…å®¹ [citation](2)
            testSaveContent() {
                const testContent = JSON.stringify({
                    title: 'æµ‹è¯•æ•°æ®',
                    timestamp: new Date().toISOString(),
                    data: {
                        numbers: [1, 2, 3, 4, 5],
                        text: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶',
                        boolean: true
                    }
                }, null, 2);

                const ctx = this.initFilePicker(this.fileSaver);
                if (ctx) {
                    ctx.sendSaveAsData(testContent, 'json', 'æµ‹è¯•æ•°æ®æ–‡ä»¶');
                    ctx.open();
                    
                    this.updateResults({
                        success: true,
                        message: 'ä¿å­˜å†…å®¹æµ‹è¯•',
                        details: 'å‡†å¤‡ä¿å­˜JSONæ ¼å¼çš„æµ‹è¯•æ•°æ®',
                        contentPreview: testContent.substring(0, 100) + '...'
                    });
                }
            }

            // æµ‹è¯•ç½‘ç›˜é›†æˆ
            testNetworkDisk() {
                this.updateResults({
                    success: true,
                    message: 'ç½‘ç›˜é›†æˆæµ‹è¯•',
                    details: 'æ–‡ä»¶é€‰æ‹©å™¨å°†è¿æ¥åˆ°æ‡’çŒ«ç½‘ç›˜ç³»ç»Ÿ',
                    features: [
                        'è®¿é—®ç½‘ç›˜æ–‡ä»¶å’Œç›®å½•',
                        'æ”¯æŒæ–‡ä»¶ä¸Šä¼ ä¸‹è½½',
                        'ç›®å½•å¯¼èˆªå’Œé¢åŒ…å±‘',
                        'æ–‡ä»¶ç±»å‹è¯†åˆ«å’Œé¢„è§ˆ'
                    ]
                });
                this.openFileSelector();
            }

            // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
            async uploadFile() {
                const fileInput = document.getElementById('fileInput');
                const files = fileInput.files;
                
                if (files.length === 0) {
                    this.updateResults({
                        success: false,
                        message: 'è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶'
                    });
                    return;
                }

                const progressBar = document.getElementById('uploadProgress');
                const progressFill = progressBar.querySelector('.progress-fill');
                progressBar.style.display = 'block';

                try {
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const formData = new FormData();
                        formData.append('file', file);

                        const response = await fetch('/api/upload', {
                            method: 'POST',
                            body: formData
                        });

                        const result = await response.json();
                        
                        if (result.success) {
                            this.updateResults({
                                success: true,
                                message: `æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${file.name}`,
                                fileInfo: result.file
                            });
                        } else {
                            throw new Error(result.error);
                        }

                        // æ›´æ–°è¿›åº¦
                        const progress = ((i + 1) / files.length) * 100;
                        progressFill.style.width = `${progress}%`;
                    }

                    this.updateStatus('æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å®Œæˆ');
                    this.refreshFileList();
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥',
                        error: error.message
                    });
                } finally {
                    progressBar.style.display = 'none';
                    fileInput.value = '';
                }
            }

            // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
            async refreshFileList() {
                try {
                    const response = await fetch('/api/files');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.displayFileList(result.files);
                        this.updateStatus('æ–‡ä»¶åˆ—è¡¨å·²åˆ·æ–°');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: 'è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥',
                        error: error.message
                    });
                }
            }

            // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
            displayFileList(files) {
                const fileListContainer = document.getElementById('fileList');
                
                if (files.length === 0) {
                    fileListContainer.innerHTML = '<p class="placeholder">æš‚æ— æ–‡ä»¶</p>';
                    return;
                }

                const fileListHTML = files.map(file => `
                    <div class="file-item">
                        <div class="file-info">
                            <span class="file-name">${file.name}</span>
                            <span class="file-size">${this.formatFileSize(file.size)}</span>
                            <span class="file-date">${new Date(file.created).toLocaleString()}</span>
                        </div>
                        <div class="file-actions">
                            <button onclick="tester.downloadFile('${file.name}')" class="btn btn-small">ä¸‹è½½</button>
                            <button onclick="tester.deleteFile('${file.name}')" class="btn btn-small btn-danger">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');

                fileListContainer.innerHTML = fileListHTML;
            }

            // ä¸‹è½½æ–‡ä»¶
            downloadFile(filename) {
                const downloadUrl = `/api/download/${encodeURIComponent(filename)}`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                this.updateStatus(`å¼€å§‹ä¸‹è½½æ–‡ä»¶: ${filename}`);
            }

            // åˆ é™¤æ–‡ä»¶
            async deleteFile(filename) {
                if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${filename}" å—ï¼Ÿ`)) {
                    return;
                }

                try {
                    const response = await fetch(`/api/files/${encodeURIComponent(filename)}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.updateResults({
                            success: true,
                            message: `æ–‡ä»¶åˆ é™¤æˆåŠŸ: ${filename}`
                        });
                        this.refreshFileList();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    this.updateResults({
                        success: false,
                        message: 'æ–‡ä»¶åˆ é™¤å¤±è´¥',
                        error: error.message
                    });
                }
            }

            // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            initEventListeners() {
                // æ–‡ä»¶é€‰æ‹©å™¨äº‹ä»¶ [citation](2)
                this.fileSelector.addEventListener('submit', (e) => {
                    const selected = this.dataTransfer(e);
                    this.updateResults({
                        success: true,
                        message: 'æ–‡ä»¶é€‰æ‹©å®Œæˆ',
                        selectedFile: selected
                    });
                });

                this.fileSelector.addEventListener('visible', () => {
                    const shouldClose = confirm('ç¡®å®šè¦å…³é—­æ–‡ä»¶é€‰æ‹©å™¨å—ï¼Ÿ');
                    if (shouldClose) {
                        this.fileSelector._instance.exposed.close();
                    }
                });

                // ç›®å½•é€‰æ‹©å™¨äº‹ä»¶ [citation](2)
                this.dirSelector.addEventListener('submit', (e) => {
                    const selected = this.dataTransfer(e);
                    this.updateResults({
                        success: true,
                        message: 'ç›®å½•é€‰æ‹©å®Œæˆ',
                        selectedDir: selected
                    });
                });

                // æ–‡ä»¶ä¿å­˜å™¨äº‹ä»¶ [citation](2)
                this.fileSaver.addEventListener('done', (e) => {
                    const result = this.dataTransfer(e);
                    const { status, stat } = result;
                    
                    status.then((flag) => {
                        this.updateResults({
                            success: flag,
                            message: `æ–‡ä»¶ä¿å­˜${flag ? 'æˆåŠŸ' : 'å¤±è´¥'}`,
                            saveResult: result
                        });
                    });
                });

                // æŒ‰é’®äº‹ä»¶
                document.getElementById('openFileSelector').addEventListener('click', () => this.openFileSelector());
                document.getElementById('openDirSelector').addEventListener('click', () => this.openDirSelector());
                document.getElementById('openFileSaver').addEventListener('click', () => this.openFileSaver());
                
                document.getElementById('testFileTypes').addEventListener('click', () => this.testFileTypes());
                document.getElementById('testMultiSelect').addEventListener('click', () => this.testMultiSelect());
                document.getElementById('testSaveContent').addEventListener('click', () => this.testSaveContent());
                document.getElementById('testNetworkDisk').addEventListener('click', () => this.testNetworkDisk());
                
                document.getElementById('uploadBtn').addEventListener('click', () => this.uploadFile());
                document.getElementById('refreshFiles').addEventListener('click', () => this.refreshFileList());
            }

            // æ•°æ®ä¼ è¾“è¾…åŠ©å‡½æ•° [citation](2)
            dataTransfer(raw) {
                if (!raw) return null;
                const output = raw.detail[0];
                return output;
            }

            // æ›´æ–°ç»“æœæ˜¾ç¤º
            updateResults(result) {
                const resultsContainer = document.getElementById('results');
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${result.success ? '' : 'error'}`;
                
                let content = `<h3>${result.message}</h3>`;
                if (result.details) content += `<p><strong>è¯¦æƒ…:</strong> ${result.details}</p>`;
                if (result.note) content += `<p><strong>æ³¨æ„:</strong> ${result.note}</p>`;
                if (result.acceptTypes) content += `<p><strong>æ¥å—ç±»å‹:</strong> ${result.acceptTypes}</p>`;
                if (result.features) {
                    content += '<p><strong>åŠŸèƒ½ç‰¹æ€§:</strong></p><ul>';
                    result.features.forEach(feature => {
                        content += `<li>${feature}</li>`;
                    });
                    content += '</ul>';
                }
                if (result.error) content += `<p><strong>é”™è¯¯:</strong> ${result.error}</p>`;
                if (result.selectedFile || result.selectedDir || result.saveResult || result.fileInfo) {
                    const data = result.selectedFile || result.selectedDir || result.saveResult || result.fileInfo;
                    content += `<div class="data-preview">${JSON.stringify(data, null, 2)}</div>`;
                }
                if (result.contentPreview) content += `<div class="content-preview">${result.contentPreview}</div>`;
                
                resultItem.innerHTML = content;
                resultsContainer.appendChild(resultItem);
                resultsContainer.scrollTop = resultsContainer.scrollHeight;
            }

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            updateStatus(message) {
                const statusContainer = document.getElementById('status');
                const timestamp = new Date().toLocaleTimeString();
                statusContainer.innerHTML = `<p>[${timestamp}] ${message}</p>`;
            }
        }

        // ç­‰å¾…DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // ç­‰å¾…æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶åŠ è½½å®Œæˆ
            setTimeout(() => {
                window.tester = new FilePickerTester();
                console.log('æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•åº”ç”¨å·²å¯åŠ¨');
            }, 1000);
        });
    </script>
</body>
</html>