<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 80%;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-picker-container {
            height: 600px;
            border: 2px solid #4facfe;
            border-radius: 10px;
            overflow: hidden;
        }

        .file-preview {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .file-preview pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            max-height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
        }

        .upload-area {
            border: 2px dashed #4facfe;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-container {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .file-meta {
            font-size: 0.9rem;
            color: #6c757d;
        }
    </style>
    <!-- å¼•å…¥æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶ [citation](2) -->
    <script defer src="https://unpkg.com/@lazycatcloud/lzc-file-pickers@latest/dist/lzc-file-pickers.umd.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•å¹³å°</h1>
            <p>ä¸“ä¸šçš„æ–‡ä»¶é€‰æ‹©ã€é¢„è§ˆå’Œä¸Šä¼ è§£å†³æ–¹æ¡ˆ</p>
        </div>

        <div class="main-content">
            <!-- ç¯å¢ƒä¿¡æ¯æ£€æµ‹ -->
            <div class="section">
                <div class="section-title">ğŸ”§ ç¯å¢ƒä¿¡æ¯æ£€æµ‹</div>
                <div id="envInfo" class="info-grid"></div>
                <div class="button-group">
                    <button id="refreshEnv" class="btn btn-info">ğŸ”„ åˆ·æ–°ç¯å¢ƒä¿¡æ¯</button>
                    <button id="testPlugin" class="btn btn-primary">ğŸ§ª æµ‹è¯•æ’ä»¶çŠ¶æ€</button>
                </div>
                <div id="pluginStatus"></div>
            </div>

            <!-- æ–‡ä»¶é€‰æ‹©ä¸é¢„è§ˆ -->
            <div class="section">
                <div class="section-title">ğŸ“ æ–‡ä»¶é€‰æ‹©ä¸é¢„è§ˆ</div>
                <div class="button-group">
                    <button id="openFilePicker" class="btn btn-success">ğŸ“‚ æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨</button>
                    <button id="openDirPicker" class="btn btn-info">ğŸ“ é€‰æ‹©ç›®å½•</button>
                    <button id="clearSelection" class="btn btn-primary">ğŸ—‘ï¸ æ¸…ç©ºé€‰æ‹©</button>
                </div>
                <div id="selectedFiles"></div>
                <div id="filePreview"></div>
            </div>

            <!-- æ–‡ä»¶ä¸Šä¼  -->
            <div class="section">
                <div class="section-title">â¬†ï¸ æ–‡ä»¶ä¸Šä¼ </div>
                <div class="upload-area" id="uploadArea">
                    <div style="font-size: 3rem; margin-bottom: 15px;">ğŸ“¤</div>
                    <h3>æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©</h3>
                    <input type="file" id="fileInput" multiple style="display: none;">
                </div>
                <div class="button-group">
                    <button id="uploadToVar" class="btn btn-primary" disabled>ğŸ’¾ ä¸Šä¼ åˆ° var ç›®å½•</button>
                    <button id="uploadToCache" class="btn btn-success" disabled>ğŸ—‚ï¸ ä¸Šä¼ åˆ° cache ç›®å½•</button>
                </div>
                <div id="uploadStatus"></div>
            </div>

            <!-- æ–‡ä»¶ç®¡ç† -->
            <div class="section">
                <div class="section-title">ğŸ“‹ æ–‡ä»¶ç®¡ç†</div>
                <div class="button-group">
                    <button id="listVarFiles" class="btn btn-info">ğŸ“„ æŸ¥çœ‹ var æ–‡ä»¶</button>
                    <button id="listCacheFiles" class="btn btn-info">ğŸ“„ æŸ¥çœ‹ cache æ–‡ä»¶</button>
                </div>
                <div id="fileManagement"></div>
            </div>

            <!-- è°ƒè¯•æ—¥å¿— -->
            <div class="section">
                <div class="section-title">ğŸ› è°ƒè¯•æ—¥å¿—</div>
                <div class="button-group">
                    <button id="clearLog" class="btn btn-primary">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                </div>
                <div id="logContainer" class="log-container"></div>
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶é€‰æ‹©å™¨æ¨¡æ€æ¡† -->
    <div id="filePickerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">æ–‡ä»¶é€‰æ‹©å™¨</h3>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="filePickerContainer" class="file-picker-container">
                    <!-- æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•å¹³å°ä¸»ç±»
         * åŸºäºæ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æºç  [citation](1) å®ç°å®Œæ•´çš„æ–‡ä»¶æ“ä½œåŠŸèƒ½
         */
        class LazycatFilePickerTester {
            constructor() {
                // ç¯å¢ƒä¿¡æ¯å­˜å‚¨
                this.envInfo = null;
                // é€‰ä¸­çš„æ–‡ä»¶åˆ—è¡¨ - ä¿®å¤ï¼šç¡®ä¿åˆå§‹åŒ–ä¸ºæ•°ç»„
                this.selectedFiles = [];
                // ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ - ä¿®å¤ï¼šæ·»åŠ ç¼ºå¤±çš„å±æ€§
                this.uploadFileList = [];
                // å½“å‰æ–‡ä»¶é€‰æ‹©å™¨å®ä¾‹
                this.currentFilePicker = null;
                // æ—¥å¿—å®¹å™¨
                this.logContainer = document.getElementById('logContainer');
                // å½“å‰ç”¨æˆ·å
                this.currentUser = 'admin'; // é»˜è®¤ç”¨æˆ·åï¼Œå®é™…åº”ä»APIè·å–
                
                // åˆå§‹åŒ–åº”ç”¨
                this.init();
            }

            /**
             * åˆå§‹åŒ–åº”ç”¨
             */
            async init() {
                this.log('ğŸš€ åˆå§‹åŒ–æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æµ‹è¯•å¹³å°...');
                
                try {
                    // åŠ è½½ç¯å¢ƒä¿¡æ¯
                    await this.loadEnvironment();
                    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
                    await this.loadUserInfo();
                    // æµ‹è¯•æ’ä»¶çŠ¶æ€
                    await this.testPluginStatus();
                    // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                    this.bindEvents();
                    
                    this.log('âœ… æµ‹è¯•å¹³å°åˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    this.log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                }
            }

            /**
             * åŠ è½½æ‡’çŒ«å¾®æœç¯å¢ƒä¿¡æ¯
             */
            async loadEnvironment() {
                try {
                    const response = await fetch('/api/lazycat-env');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.envInfo = result.environment;
                        this.displayEnvironmentInfo();
                        this.log('âœ… ç¯å¢ƒä¿¡æ¯åŠ è½½æˆåŠŸ');
                    } else {
                        throw new Error('æ— æ³•è·å–ç¯å¢ƒä¿¡æ¯');
                    }
                } catch (error) {
                    this.log(`âŒ ç¯å¢ƒä¿¡æ¯åŠ è½½å¤±è´¥: ${error.message}`, 'error');
                    throw error;
                }
            }

            /**
             * åŠ è½½ç”¨æˆ·ä¿¡æ¯
             */
            async loadUserInfo() {
                try {
                    const response = await fetch('/api/user-info');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.currentUser = result.user.id;
                        this.log(`âœ… ç”¨æˆ·ä¿¡æ¯åŠ è½½æˆåŠŸ: ${this.currentUser}`);
                    }
                } catch (error) {
                    this.log(`âŒ ç”¨æˆ·ä¿¡æ¯åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ç”¨æˆ·: ${this.currentUser}`, 'warning');
                }
            }

            /**
             * æµ‹è¯•æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶çŠ¶æ€
             */
            async testPluginStatus() {
                this.log('ğŸ” æ’ä»¶çŠ¶æ€æ£€æµ‹...');
                
                const status = {
                    'æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶': 'unknown',
                    'CustomElementsæ”¯æŒ': 'unknown',
                    'postMessageæ”¯æŒ': 'unknown',
                    'æ–‡ä»¶æœåŠ¡å™¨è¿é€šæ€§': 'unknown'
                };

                // æ£€æŸ¥æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶ [citation](1)
                try {
                    if (typeof customElements !== 'undefined' && customElements.get('lzc-file-picker')) {
                        status['æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶'] = 'âœ… å·²åŠ è½½';
                    } else {
                        status['æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶'] = 'âŒ æœªåŠ è½½';
                    }
                } catch (error) {
                    status['æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶'] = 'âŒ æ£€æŸ¥å¤±è´¥';
                }

                // æ£€æŸ¥ CustomElements æ”¯æŒ
                status['CustomElementsæ”¯æŒ'] = typeof customElements !== 'undefined' ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ';
                
                // æ£€æŸ¥ postMessage æ”¯æŒ
                status['postMessageæ”¯æŒ'] = typeof window.postMessage === 'function' ? 'âœ… æ”¯æŒ' : 'âŒ ä¸æ”¯æŒ';
                
                // æ£€æŸ¥æ–‡ä»¶æœåŠ¡å™¨è¿é€šæ€§
                if (this.envInfo && this.envInfo.filePickerDomain) {
                    status['æ–‡ä»¶æœåŠ¡å™¨è¿é€šæ€§'] = 'âœ… åŸŸåå¯è®¿é—®';
                }

                this.displayPluginStatus(status);
                this.log('ğŸ” æ’ä»¶çŠ¶æ€æ£€æµ‹å®Œæˆ');
            }

            /**
             * æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
             */
            displayEnvironmentInfo() {
                const envInfo = document.getElementById('envInfo');
                envInfo.innerHTML = `
                    <div class="info-item">
                        <div><strong>ğŸ·ï¸ è®¾å¤‡åç§°:</strong> ${this.envInfo.boxName}</div>
                    </div>
                    <div class="info-item">
                        <div><strong>ğŸŒ æ–‡ä»¶é€‰æ‹©å™¨åŸŸå:</strong> ${this.envInfo.filePickerDomain}</div>
                    </div>
                    <div class="info-item">
                        <div><strong>ğŸ”— åº”ç”¨åŸŸå:</strong> ${this.envInfo.appDomain}</div>
                    </div>
                    <div class="info-item">
                        <div><strong>ğŸ‘¤ å½“å‰ç”¨æˆ·:</strong> ${this.currentUser}</div>
                    </div>
                `;
            }

            /**
             * æ˜¾ç¤ºæ’ä»¶çŠ¶æ€
             */
            displayPluginStatus(status) {
                const pluginStatus = document.getElementById('pluginStatus');
                let html = '<div class="info-grid">';
                
                for (const [key, value] of Object.entries(status)) {
                    const isError = value.includes('âŒ') || value.includes('å¤±è´¥') || value === 'unknown';
                    const statusClass = isError ? 'error' : 'success';
                    html += `
                        <div class="info-item">
                            <div><strong>${key}:</strong></div>
                            <div>
                                <span class="status ${statusClass}" style="display: inline; padding: 4px 8px;">${value}</span>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                pluginStatus.innerHTML = html;
            }

            /**
             * ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
             */
            bindEvents() {
                // ç¯å¢ƒä¿¡æ¯æŒ‰é’®
                document.getElementById('refreshEnv').addEventListener('click', () => {
                    this.loadEnvironment();
                });

                document.getElementById('testPlugin').addEventListener('click', () => {
                    this.testPluginStatus();
                });

                // æ–‡ä»¶é€‰æ‹©æŒ‰é’®
                document.getElementById('openFilePicker').addEventListener('click', () => {
                    this.openFilePicker('file');
                });

                document.getElementById('openDirPicker').addEventListener('click', () => {
                    this.openFilePicker('directory');
                });

                document.getElementById('clearSelection').addEventListener('click', () => {
                    this.clearSelection();
                });

                // æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');

                uploadArea.addEventListener('click', () => {
                    fileInput.click();
                });

                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    this.handleFileSelection(e.dataTransfer.files);
                });

                fileInput.addEventListener('change', (e) => {
                    this.handleFileSelection(e.target.files);
                });

                // ä¸Šä¼ æŒ‰é’® - ä¿®å¤ï¼šç»‘å®šæ­£ç¡®çš„æ–¹æ³•å
                document.getElementById('uploadToVar').addEventListener('click', () => {
                    this.uploadFiles('var');
                });

                document.getElementById('uploadToCache').addEventListener('click', () => {
                    this.uploadFiles('cache');
                });

                // æ–‡ä»¶ç®¡ç†æŒ‰é’®
                document.getElementById('listVarFiles').addEventListener('click', () => {
                    this.listFiles('var');
                });

                document.getElementById('listCacheFiles').addEventListener('click', () => {
                    this.listFiles('cache');
                });

                // æ¨¡æ€æ¡†å…³é—­
                document.getElementById('closeModal').addEventListener('click', () => {
                    this.closeFilePicker();
                });

                // æ—¥å¿—æ“ä½œ
                document.getElementById('clearLog').addEventListener('click', () => {
                    this.logContainer.textContent = '';
                });
            }

            /**
             * æ‰“å¼€æ–‡ä»¶é€‰æ‹©å™¨
             * @param {string} type - é€‰æ‹©å™¨ç±»å‹ï¼š'file' æˆ– 'directory'
             */
            openFilePicker(type) {
                this.log(`ğŸ“‚ æ‰“å¼€${type === 'file' ? 'æ–‡ä»¶' : 'ç›®å½•'}é€‰æ‹©å™¨...`);
                
                try {
                    // åˆ›å»ºæ–‡ä»¶é€‰æ‹©å™¨å…ƒç´  [citation](2)
                    const picker = document.createElement('lzc-file-picker');
                    picker.setAttribute('box-id', this.envInfo.boxName);
                    picker.setAttribute('type', type);
                    picker.setAttribute('title', type === 'file' ? 'é€‰æ‹©æ–‡ä»¶' : 'é€‰æ‹©ç›®å½•');
                    picker.setAttribute('multiple', 'true');
                    
                    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                    this.setupFilePickerEvents(picker);
                    
                    // æ˜¾ç¤ºåœ¨æ¨¡æ€æ¡†ä¸­
                    this.displayFilePickerModal(picker, type === 'file' ? 'é€‰æ‹©æ–‡ä»¶' : 'é€‰æ‹©ç›®å½•');
                    
                    this.currentFilePicker = picker;
                    
                } catch (error) {
                    this.log(`âŒ æ–‡ä»¶é€‰æ‹©å™¨åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
                }
            }

            /**
             * è®¾ç½®æ–‡ä»¶é€‰æ‹©å™¨äº‹ä»¶ç›‘å¬å™¨
             * @param {HTMLElement} picker - æ–‡ä»¶é€‰æ‹©å™¨å…ƒç´ 
             */
            setupFilePickerEvents(picker) {
                // æ–‡ä»¶é€‰æ‹©å®Œæˆäº‹ä»¶ [citation](2)
                picker.addEventListener('submit', (event) => {
                    this.log('ğŸ“ æ–‡ä»¶é€‰æ‹©å®Œæˆ');
                    this.handleFilePickerSelection(event);
                });

                // å…³é—­äº‹ä»¶
                picker.addEventListener('close', () => {
                    this.log('ğŸ“‚ æ–‡ä»¶é€‰æ‹©å™¨å·²å…³é—­');
                    this.closeFilePicker();
                });

                // é”™è¯¯äº‹ä»¶
                picker.addEventListener('error', (event) => {
                    this.log(`âŒ æ–‡ä»¶é€‰æ‹©å™¨é”™è¯¯: ${event.detail}`, 'error');
                });
            }

            /**
             * æ˜¾ç¤ºæ–‡ä»¶é€‰æ‹©å™¨æ¨¡æ€æ¡†
             * @param {HTMLElement} picker - æ–‡ä»¶é€‰æ‹©å™¨å…ƒç´ 
             * @param {string} title - æ¨¡æ€æ¡†æ ‡é¢˜
             */
            displayFilePickerModal(picker, title) {
                const modal = document.getElementById('filePickerModal');
                const modalTitle = document.getElementById('modalTitle');
                const container = document.getElementById('filePickerContainer');
                
                modalTitle.textContent = title;
                container.innerHTML = '';
                container.appendChild(picker);
                modal.style.display = 'block';
            }

            /**
             * å…³é—­æ–‡ä»¶é€‰æ‹©å™¨
             */
            closeFilePicker() {
                const modal = document.getElementById('filePickerModal');
                modal.style.display = 'none';
                this.currentFilePicker = null;
            }

            /**
             * å¤„ç†æ–‡ä»¶é€‰æ‹©å™¨é€‰æ‹©ç»“æœ
             * @param {CustomEvent} event - é€‰æ‹©äº‹ä»¶
             */
            handleFilePickerSelection(event) {
                try {
                    // ä¿®å¤ï¼šæ­£ç¡®è§£ææ–‡ä»¶æ•°æ® [citation](1)
                    const fileData = this.parseFilePickerData(event.detail);
                    this.selectedFiles = Array.isArray(fileData) ? fileData : [fileData];
                    
                    this.log(`ğŸ“ é€‰æ‹©äº† ${this.selectedFiles.length} ä¸ªæ–‡ä»¶/ç›®å½•`);
                    this.displaySelectedFiles();
                    this.closeFilePicker();
                } catch (error) {
                    this.log(`âŒ æ–‡ä»¶æ•°æ®è§£æå¤±è´¥: ${error.message}`, 'error');
                }
            }

            /**
             * è§£ææ–‡ä»¶é€‰æ‹©å™¨è¿”å›çš„æ•°æ®
             * @param {any} rawData - åŸå§‹æ•°æ®
             * @returns {Array} è§£æåçš„æ–‡ä»¶æ•°ç»„
             */
            parseFilePickerData(rawData) {
                if (!rawData || !rawData[0]) {
                    throw new Error('æ— æ•ˆçš„æ–‡ä»¶æ•°æ®');
                }

                let fileList;
                try {
                    // å¤„ç†å¯èƒ½çš„ JSON å­—ç¬¦ä¸²æ ¼å¼
                    if (typeof rawData[0] === 'string') {
                        fileList = JSON.parse(rawData[0]);
                    } else {
                        fileList = rawData[0];
                    }
                } catch (error) {
                    throw new Error('æ–‡ä»¶æ•°æ®æ ¼å¼é”™è¯¯');
                }

                // ç¡®ä¿è¿”å›æ•°ç»„æ ¼å¼
                return Array.isArray(fileList) ? fileList : [fileList];
            }

            /**
             * æ˜¾ç¤ºé€‰ä¸­çš„æ–‡ä»¶
             */
            async displaySelectedFiles() {
                const container = document.getElementById('selectedFiles');
                if (!container || !this.selectedFiles.length) return;

                let html = '<div class="file-list"><h4>ğŸ“ å·²é€‰æ‹©çš„æ–‡ä»¶</h4>';
                
                for (const file of this.selectedFiles) {
                    html += await this.generateFileItem(file);
                }
                
                html += '</div>';
                container.innerHTML = html;
            }

            /**
             * ç”Ÿæˆæ–‡ä»¶é¡¹ç›®HTML
             * @param {Object} file - æ–‡ä»¶å¯¹è±¡
             * @returns {string} HTMLå­—ç¬¦ä¸²
             */
            async generateFileItem(file) {
                const isImage = this.isImageFile(file);
                const isText = this.isTextFile(file);
                
                let previewHtml = '';
                
                if (isImage) {
                    // å›¾ç‰‡é¢„è§ˆ - ä½¿ç”¨ç½‘ç›˜æ–‡ä»¶è·¯å¾„
                    const imageUrl = this.getCloudFilePreviewUrl(file);
                    previewHtml = `
                        <div class="file-preview">
                            <img src="${imageUrl}" alt="${file.basename}" 
                                 style="max-width: 200px; max-height: 150px; border-radius: 8px;"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div style="display: none; color: #999;">å›¾ç‰‡åŠ è½½å¤±è´¥</div>
                        </div>
                    `;
                } else if (isText) {
                    // æ–‡æœ¬æ–‡ä»¶é¢„è§ˆ - ä½¿ç”¨ç½‘ç›˜æ–‡ä»¶è·¯å¾„
                    try {
                        const textContent = await this.getCloudFileContent(file);
                        previewHtml = `
                            <div class="file-preview">
                                <pre style="max-height: 100px; overflow-y: auto; background: #f5f5f5; padding: 10px; border-radius: 4px;">
                                    ${this.escapeHtml(textContent.substring(0, 500))}${textContent.length > 500 ? '...' : ''}
                                </pre>
                            </div>
                        `;
                    } catch (error) {
                        previewHtml = `
                            <div class="file-preview">
                                <div style="color: #999;">æ–‡æœ¬å†…å®¹åŠ è½½å¤±è´¥</div>
                            </div>
                        `;
                    }
                }

                return `
                    <div class="file-item" data-filename="${file.filename}">
                        <div class="file-info">
                            <div class="file-name">ğŸ“„ ${file.basename}</div>
                            <div class="file-meta">
                                å¤§å°: ${this.formatFileSize(file.size)} | 
                                ç±»å‹: ${file.mime || 'æœªçŸ¥'} | 
                                ä¿®æ”¹æ—¶é—´: ${new Date(file.lastmod).toLocaleString()} |
                                è·¯å¾„: /lzcapp/run/mnt/home/${this.currentUser}${file.filename}
                            </div>
                            ${previewHtml}
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-primary" onclick="filePicker.downloadCloudFile('${file.filename}')">
                                ğŸ“¥ ä¸‹è½½
                            </button>
                            ${isImage ? `<button class="btn btn-info" onclick="filePicker.viewFullImage('${file.filename}')">ğŸ” æŸ¥çœ‹å¤§å›¾</button>` : ''}
                        </div>
                    </div>
                `;
            }

            /**
             * è·å–ç½‘ç›˜æ–‡ä»¶é¢„è§ˆURL
             * @param {Object} file - æ–‡ä»¶å¯¹è±¡
             * @returns {string} é¢„è§ˆURL
             */
            getCloudFilePreviewUrl(file) {
                // æ„å»ºç½‘ç›˜æ–‡ä»¶çš„é¢„è§ˆURL
                return `/api/cloud-file/preview?file=${encodeURIComponent(file.filename)}&type=image`;
            }

            /**
             * è·å–ç½‘ç›˜æ–‡ä»¶å†…å®¹
             * @param {Object} file - æ–‡ä»¶å¯¹è±¡
             * @returns {Promise<string>} æ–‡ä»¶å†…å®¹
             */
            async getCloudFileContent(file) {
                try {
                    const response = await fetch(`/api/cloud-file/content?file=${encodeURIComponent(file.filename)}`);
                    if (response.ok) {
                        const result = await response.json();
                        return result.content || 'æ— æ³•åŠ è½½æ–‡ä»¶å†…å®¹';
                    }
                    return 'æ–‡ä»¶å†…å®¹åŠ è½½å¤±è´¥';
                } catch (error) {
                    return 'æ–‡ä»¶å†…å®¹åŠ è½½å¤±è´¥';
                }
            }

            /**
             * ä¸‹è½½ç½‘ç›˜æ–‡ä»¶
             * @param {string} filename - æ–‡ä»¶å
             */
            async downloadCloudFile(filename) {
                try {
                    this.log(`ğŸ“¥ å¼€å§‹ä¸‹è½½ç½‘ç›˜æ–‡ä»¶: ${filename}`);
                    
                    // æ„å»ºä¸‹è½½URL - ç½‘ç›˜æ–‡ä»¶ä¸‹è½½
                    const downloadUrl = `/api/cloud-file/download?file=${encodeURIComponent(filename)}`;
                    
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = filename.split('/').pop(); // è·å–æ–‡ä»¶å
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.log(`âœ… ç½‘ç›˜æ–‡ä»¶ä¸‹è½½å·²å¯åŠ¨: ${filename}`, 'success');
                } catch (error) {
                    this.log(`âŒ ç½‘ç›˜æ–‡ä»¶ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
                }
            }

            /**
             * æŸ¥çœ‹å¤§å›¾
             * @param {string} filename - æ–‡ä»¶å
             */
            viewFullImage(filename) {
                const file = this.selectedFiles.find(f => f.filename === filename);
                if (!file) return;

                const modal = document.createElement('div');
                modal.className = 'image-modal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.8); z-index: 1000; display: flex;
                    align-items: center; justify-content: center; cursor: pointer;
                `;

                const img = document.createElement('img');
                img.src = this.getCloudFilePreviewUrl(file);
                img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';

                modal.appendChild(img);
                document.body.appendChild(modal);

                modal.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            }

            /**
             * æ¸…ç©ºé€‰æ‹©
             */
            clearSelection() {
                this.selectedFiles = [];
                const container = document.getElementById('selectedFiles');
                if (container) {
                    container.innerHTML = '';
                }
                this.log('ğŸ—‘ï¸ å·²æ¸…ç©ºæ–‡ä»¶é€‰æ‹©');
            }

            /**
             * å¤„ç†æ–‡ä»¶é€‰æ‹©ï¼ˆç”¨äºä¸Šä¼ ï¼‰
             * @param {FileList} files - é€‰æ‹©çš„æ–‡ä»¶åˆ—è¡¨
             */
            handleFileSelection(files) {
                this.uploadFileList = Array.from(files);
                this.log(`ğŸ“¤ é€‰æ‹©äº† ${this.uploadFileList.length} ä¸ªæ–‡ä»¶å‡†å¤‡ä¸Šä¼ `);
                
                // å¯ç”¨ä¸Šä¼ æŒ‰é’®
                document.getElementById('uploadToVar').disabled = false;
                document.getElementById('uploadToCache').disabled = false;
                
                // æ˜¾ç¤ºé€‰æ‹©çš„æ–‡ä»¶ä¿¡æ¯
                this.displayUploadFiles();
            }

            /**
             * æ˜¾ç¤ºå¾…ä¸Šä¼ æ–‡ä»¶
             */
            displayUploadFiles() {
                const statusContainer = document.getElementById('uploadStatus');
                if (!this.uploadFileList.length) return;

                let html = '<div class="file-list"><h4>ğŸ“¤ å¾…ä¸Šä¼ æ–‡ä»¶</h4>';
                this.uploadFileList.forEach(file => {
                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-name">ğŸ“„ ${file.name}</div>
                                <div class="file-meta">
                                    å¤§å°: ${this.formatFileSize(file.size)} | 
                                    ç±»å‹: ${file.type || 'æœªçŸ¥'}
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                statusContainer.innerHTML = html;
            }

            /**
             * ä¸Šä¼ æ–‡ä»¶
             * @param {string} storageType - å­˜å‚¨ç±»å‹ï¼š'var' æˆ– 'cache'
             */
            async uploadFiles(storageType) {
                if (!this.uploadFileList.length) {
                    this.log('âŒ æ²¡æœ‰é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'error');
                    return;
                }

                this.log(`ğŸ“¤ å¼€å§‹ä¸Šä¼  ${this.uploadFileList.length} ä¸ªæ–‡ä»¶åˆ° ${storageType} ç›®å½•...`);

                try {
                    const formData = new FormData();
                    this.uploadFileList.forEach(file => {
                        formData.append('files', file);
                    });

                    const response = await fetch(`/api/upload/${storageType}`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.log(`âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${result.message}`, 'success');
                        this.displayUploadResult(result);
                        
                        // æ¸…ç©ºä¸Šä¼ åˆ—è¡¨
                        this.uploadFileList = [];
                        document.getElementById('uploadToVar').disabled = true;
                        document.getElementById('uploadToCache').disabled = true;
                        document.getElementById('uploadStatus').innerHTML = '';
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    this.log(`âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
                }
            }

            /**
             * æ˜¾ç¤ºä¸Šä¼ ç»“æœ
             * @param {Object} result - ä¸Šä¼ ç»“æœ
             */
            displayUploadResult(result) {
                const statusContainer = document.getElementById('uploadStatus');
                let html = `
                    <div class="status success">
                        <strong>âœ… ${result.message}</strong>
                        <div>å­˜å‚¨è·¯å¾„: ${result.storageInfo.uploadPath}</div>
                    </div>
                    <div class="file-list">
                `;

                result.files.forEach(file => {
                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-name">ğŸ“„ ${file.originalName}</div>
                                <div class="file-meta">
                                    å¤§å°: ${this.formatFileSize(file.size)} | 
                                    å­˜å‚¨å: ${file.filename} |
                                    å­˜å‚¨è·¯å¾„: ${file.storagePath}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                statusContainer.innerHTML = html;
            }

            /**
             * åˆ—å‡ºæ–‡ä»¶
             * @param {string} storageType - å­˜å‚¨ç±»å‹
             */
            async listFiles(storageType) {
                this.log(`ğŸ“‹ è·å– ${storageType} ç›®å½•æ–‡ä»¶åˆ—è¡¨...`);

                try {
                    const response = await fetch(`/api/files/${storageType}`);
                    const result = await response.json();

                    if (result.success) {
                        this.log(`âœ… è·å–åˆ° ${result.files.length} ä¸ªæ–‡ä»¶`);
                        this.displayFileList(result.files, storageType);
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    this.log(`âŒ è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
                }
            }

            /**
             * æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
             * @param {Array} files - æ–‡ä»¶åˆ—è¡¨
             * @param {string} storageType - å­˜å‚¨ç±»å‹
             */
            displayFileList(files, storageType) {
                const container = document.getElementById('fileManagement');
                
                let html = `<div class="file-list"><h4>ğŸ“‹ ${storageType.toUpperCase()} ç›®å½•æ–‡ä»¶åˆ—è¡¨</h4>`;
                
                if (files.length === 0) {
                    html += '<div class="status info">ğŸ“ ç›®å½•ä¸ºç©º</div>';
                } else {
                    files.forEach(file => {
                        html += `
                            <div class="file-item">
                                <div class="file-info">
                                    <div class="file-name">ğŸ“„ ${file.filename}</div>
                                    <div class="file-meta">
                                        å¤§å°: ${this.formatFileSize(file.size)} | 
                                        ä¸Šä¼ æ—¶é—´: ${new Date(file.uploadTime).toLocaleString()}
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <button class="btn btn-primary" onclick="filePicker.deleteFile('${storageType}', '${file.filename}')">
                                        ğŸ—‘ï¸ åˆ é™¤
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                container.innerHTML = html;
            }

            /**
             * åˆ é™¤æ–‡ä»¶
             * @param {string} storageType - å­˜å‚¨ç±»å‹
             * @param {string} filename - æ–‡ä»¶å
             */
            async deleteFile(storageType, filename) {
                if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ ${filename} å—ï¼Ÿ`)) {
                    return;
                }

                try {
                    const response = await fetch(`/api/files/${storageType}/${filename}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.log(`âœ… æ–‡ä»¶åˆ é™¤æˆåŠŸ: ${filename}`, 'success');
                        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                        this.listFiles(storageType);
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    this.log(`âŒ æ–‡ä»¶åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
                }
            }

            // å·¥å…·æ–¹æ³•
            isImageFile(file) {
                const imageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                return imageTypes.includes(file.mime) || /\.(jpg|jpeg|png|gif|webp)$/i.test(file.basename);
            }

            isTextFile(file) {
                const textTypes = ['text/plain', 'text/html', 'text/css', 'text/javascript', 'application/json'];
                return textTypes.includes(file.mime) || /\.(txt|html|css|js|json|md)$/i.test(file.basename);
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            log(message, level = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[LazycatFilePicker] ${message}`);
                
                // å¦‚æœæœ‰æ—¥å¿—å®¹å™¨ï¼Œä¹Ÿæ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
                if (this.logContainer) {
                    const logEntry = document.createElement('div');
                    logEntry.textContent = `[${timestamp}] ${message}`;
                    logEntry.className = `log-entry log-${level}`;
                    this.logContainer.appendChild(logEntry);
                    this.logContainer.scrollTop = this.logContainer.scrollHeight;
                }
            }
        }

        // å…¨å±€å®ä¾‹
        const filePicker = new LazycatFilePickerTester();
    </script>
</body>
</html>