<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>懒猫文件选择器测试平台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #dee2e6;
        }

        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 80%;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-picker-container {
            height: 600px;
            border: 2px solid #4facfe;
            border-radius: 10px;
            overflow: hidden;
        }

        .file-preview {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .file-preview pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            max-height: 300px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
        }

        .upload-area {
            border: 2px dashed #4facfe;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .log-container {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .file-meta {
            font-size: 0.9rem;
            color: #6c757d;
        }
    </style>
    <!-- 引入懒猫文件选择器插件 [citation](2) -->
    <script defer src="https://unpkg.com/@lazycatcloud/lzc-file-pickers@latest/dist/lzc-file-pickers.umd.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 懒猫文件选择器测试平台</h1>
            <p>专业的文件选择、预览和上传解决方案</p>
        </div>

        <div class="main-content">
            <!-- 环境信息检测 -->
            <div class="section">
                <div class="section-title">🔧 环境信息检测</div>
                <div id="envInfo" class="info-grid"></div>
                <div class="button-group">
                    <button id="refreshEnv" class="btn btn-info">🔄 刷新环境信息</button>
                    <button id="testPlugin" class="btn btn-primary">🧪 测试插件状态</button>
                </div>
                <div id="pluginStatus"></div>
            </div>

            <!-- 文件选择与预览 -->
            <div class="section">
                <div class="section-title">📁 文件选择与预览</div>
                <div class="button-group">
                    <button id="openFilePicker" class="btn btn-success">📂 打开文件选择器</button>
                    <button id="openDirPicker" class="btn btn-info">📁 选择目录</button>
                    <button id="clearSelection" class="btn btn-primary">🗑️ 清空选择</button>
                </div>
                <div id="selectedFiles"></div>
                <div id="filePreview"></div>
            </div>

            <!-- 文件上传 -->
            <div class="section">
                <div class="section-title">⬆️ 文件上传</div>
                <div class="upload-area" id="uploadArea">
                    <div style="font-size: 3rem; margin-bottom: 15px;">📤</div>
                    <h3>拖拽文件到此处或点击选择</h3>
                    <input type="file" id="fileInput" multiple style="display: none;">
                </div>
                <div class="button-group">
                    <button id="uploadToVar" class="btn btn-primary" disabled>💾 上传到 var 目录</button>
                    <button id="uploadToCache" class="btn btn-success" disabled>🗂️ 上传到 cache 目录</button>
                </div>
                <div id="uploadStatus"></div>
            </div>

            <!-- 文件管理 -->
            <div class="section">
                <div class="section-title">📋 文件管理</div>
                <div class="button-group">
                    <button id="listVarFiles" class="btn btn-info">📄 查看 var 文件</button>
                    <button id="listCacheFiles" class="btn btn-info">📄 查看 cache 文件</button>
                </div>
                <div id="fileManagement"></div>
            </div>

            <!-- 调试日志 -->
            <div class="section">
                <div class="section-title">🐛 调试日志</div>
                <div class="button-group">
                    <button id="clearLog" class="btn btn-primary">🗑️ 清空日志</button>
                </div>
                <div id="logContainer" class="log-container"></div>
            </div>
        </div>
    </div>

    <!-- 文件选择器模态框 -->
    <div id="filePickerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">文件选择器</h3>
                <button class="close-btn" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="filePickerContainer" class="file-picker-container">
                    <!-- 懒猫文件选择器将在这里渲染 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * 懒猫文件选择器测试平台主类
         * 基于懒猫文件选择器源码 [citation](1) 实现完整的文件操作功能
         */
        class LazycatFilePickerTester {
            constructor() {
                // 环境信息存储
                this.envInfo = null;
                // 选中的文件列表 - 修复：确保初始化为数组
                this.selectedFiles = [];
                // 上传文件列表 - 修复：添加缺失的属性
                this.uploadFileList = [];
                // 当前文件选择器实例
                this.currentFilePicker = null;
                // 日志容器
                this.logContainer = document.getElementById('logContainer');
                // 当前用户名
                this.currentUser = 'admin'; // 默认用户名，实际应从API获取
                
                // 初始化应用
                this.init();
            }

            /**
             * 初始化应用
             */
            async init() {
                this.log('🚀 初始化懒猫文件选择器测试平台...');
                
                try {
                    // 加载环境信息
                    await this.loadEnvironment();
                    // 获取当前用户信息
                    await this.loadUserInfo();
                    // 测试插件状态
                    await this.testPluginStatus();
                    // 绑定事件监听器
                    this.bindEvents();
                    
                    this.log('✅ 测试平台初始化完成');
                } catch (error) {
                    this.log(`❌ 初始化失败: ${error.message}`, 'error');
                }
            }

            /**
             * 加载懒猫微服环境信息
             */
            async loadEnvironment() {
                try {
                    const response = await fetch('/api/lazycat-env');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.envInfo = result.environment;
                        this.displayEnvironmentInfo();
                        this.log('✅ 环境信息加载成功');
                    } else {
                        throw new Error('无法获取环境信息');
                    }
                } catch (error) {
                    this.log(`❌ 环境信息加载失败: ${error.message}`, 'error');
                    throw error;
                }
            }

            /**
             * 加载用户信息
             */
            async loadUserInfo() {
                try {
                    const response = await fetch('/api/user-info');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.currentUser = result.user.id;
                        this.log(`✅ 用户信息加载成功: ${this.currentUser}`);
                    }
                } catch (error) {
                    this.log(`❌ 用户信息加载失败，使用默认用户: ${this.currentUser}`, 'warning');
                }
            }

            /**
             * 测试懒猫文件选择器插件状态
             */
            async testPluginStatus() {
                this.log('🔍 插件状态检测...');
                
                const status = {
                    '懒猫文件选择器插件': 'unknown',
                    'CustomElements支持': 'unknown',
                    'postMessage支持': 'unknown',
                    '文件服务器连通性': 'unknown'
                };

                // 检查懒猫文件选择器插件 [citation](1)
                try {
                    if (typeof customElements !== 'undefined' && customElements.get('lzc-file-picker')) {
                        status['懒猫文件选择器插件'] = '✅ 已加载';
                    } else {
                        status['懒猫文件选择器插件'] = '❌ 未加载';
                    }
                } catch (error) {
                    status['懒猫文件选择器插件'] = '❌ 检查失败';
                }

                // 检查 CustomElements 支持
                status['CustomElements支持'] = typeof customElements !== 'undefined' ? '✅ 支持' : '❌ 不支持';
                
                // 检查 postMessage 支持
                status['postMessage支持'] = typeof window.postMessage === 'function' ? '✅ 支持' : '❌ 不支持';
                
                // 检查文件服务器连通性
                if (this.envInfo && this.envInfo.filePickerDomain) {
                    status['文件服务器连通性'] = '✅ 域名可访问';
                }

                this.displayPluginStatus(status);
                this.log('🔍 插件状态检测完成');
            }

            /**
             * 显示环境信息
             */
            displayEnvironmentInfo() {
                const envInfo = document.getElementById('envInfo');
                envInfo.innerHTML = `
                    <div class="info-item">
                        <div><strong>🏷️ 设备名称:</strong> ${this.envInfo.boxName}</div>
                    </div>
                    <div class="info-item">
                        <div><strong>🌐 文件选择器域名:</strong> ${this.envInfo.filePickerDomain}</div>
                    </div>
                    <div class="info-item">
                        <div><strong>🔗 应用域名:</strong> ${this.envInfo.appDomain}</div>
                    </div>
                    <div class="info-item">
                        <div><strong>👤 当前用户:</strong> ${this.currentUser}</div>
                    </div>
                `;
            }

            /**
             * 显示插件状态
             */
            displayPluginStatus(status) {
                const pluginStatus = document.getElementById('pluginStatus');
                let html = '<div class="info-grid">';
                
                for (const [key, value] of Object.entries(status)) {
                    const isError = value.includes('❌') || value.includes('失败') || value === 'unknown';
                    const statusClass = isError ? 'error' : 'success';
                    html += `
                        <div class="info-item">
                            <div><strong>${key}:</strong></div>
                            <div>
                                <span class="status ${statusClass}" style="display: inline; padding: 4px 8px;">${value}</span>
                            </div>
                        </div>
                    `;
                }
                
                html += '</div>';
                pluginStatus.innerHTML = html;
            }

            /**
             * 绑定事件监听器
             */
            bindEvents() {
                // 环境信息按钮
                document.getElementById('refreshEnv').addEventListener('click', () => {
                    this.loadEnvironment();
                });

                document.getElementById('testPlugin').addEventListener('click', () => {
                    this.testPluginStatus();
                });

                // 文件选择按钮
                document.getElementById('openFilePicker').addEventListener('click', () => {
                    this.openFilePicker('file');
                });

                document.getElementById('openDirPicker').addEventListener('click', () => {
                    this.openFilePicker('directory');
                });

                document.getElementById('clearSelection').addEventListener('click', () => {
                    this.clearSelection();
                });

                // 文件上传区域
                const uploadArea = document.getElementById('uploadArea');
                const fileInput = document.getElementById('fileInput');

                uploadArea.addEventListener('click', () => {
                    fileInput.click();
                });

                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    this.handleFileSelection(e.dataTransfer.files);
                });

                fileInput.addEventListener('change', (e) => {
                    this.handleFileSelection(e.target.files);
                });

                // 上传按钮 - 修复：绑定正确的方法名
                document.getElementById('uploadToVar').addEventListener('click', () => {
                    this.uploadFiles('var');
                });

                document.getElementById('uploadToCache').addEventListener('click', () => {
                    this.uploadFiles('cache');
                });

                // 文件管理按钮
                document.getElementById('listVarFiles').addEventListener('click', () => {
                    this.listFiles('var');
                });

                document.getElementById('listCacheFiles').addEventListener('click', () => {
                    this.listFiles('cache');
                });

                // 模态框关闭
                document.getElementById('closeModal').addEventListener('click', () => {
                    this.closeFilePicker();
                });

                // 日志操作
                document.getElementById('clearLog').addEventListener('click', () => {
                    this.logContainer.textContent = '';
                });
            }

            /**
             * 打开文件选择器
             * @param {string} type - 选择器类型：'file' 或 'directory'
             */
            openFilePicker(type) {
                this.log(`📂 打开${type === 'file' ? '文件' : '目录'}选择器...`);
                
                try {
                    // 创建文件选择器元素 [citation](2)
                    const picker = document.createElement('lzc-file-picker');
                    picker.setAttribute('box-id', this.envInfo.boxName);
                    picker.setAttribute('type', type);
                    picker.setAttribute('title', type === 'file' ? '选择文件' : '选择目录');
                    picker.setAttribute('multiple', 'true');
                    
                    // 设置事件监听器
                    this.setupFilePickerEvents(picker);
                    
                    // 显示在模态框中
                    this.displayFilePickerModal(picker, type === 'file' ? '选择文件' : '选择目录');
                    
                    this.currentFilePicker = picker;
                    
                } catch (error) {
                    this.log(`❌ 文件选择器创建失败: ${error.message}`, 'error');
                }
            }

            /**
             * 设置文件选择器事件监听器
             * @param {HTMLElement} picker - 文件选择器元素
             */
            setupFilePickerEvents(picker) {
                // 文件选择完成事件 [citation](2)
                picker.addEventListener('submit', (event) => {
                    this.log('📁 文件选择完成');
                    this.handleFilePickerSelection(event);
                });

                // 关闭事件
                picker.addEventListener('close', () => {
                    this.log('📂 文件选择器已关闭');
                    this.closeFilePicker();
                });

                // 错误事件
                picker.addEventListener('error', (event) => {
                    this.log(`❌ 文件选择器错误: ${event.detail}`, 'error');
                });
            }

            /**
             * 显示文件选择器模态框
             * @param {HTMLElement} picker - 文件选择器元素
             * @param {string} title - 模态框标题
             */
            displayFilePickerModal(picker, title) {
                const modal = document.getElementById('filePickerModal');
                const modalTitle = document.getElementById('modalTitle');
                const container = document.getElementById('filePickerContainer');
                
                modalTitle.textContent = title;
                container.innerHTML = '';
                container.appendChild(picker);
                modal.style.display = 'block';
            }

            /**
             * 关闭文件选择器
             */
            closeFilePicker() {
                const modal = document.getElementById('filePickerModal');
                modal.style.display = 'none';
                this.currentFilePicker = null;
            }

            /**
             * 处理文件选择器选择结果
             * @param {CustomEvent} event - 选择事件
             */
            handleFilePickerSelection(event) {
                try {
                    // 修复：正确解析文件数据 [citation](1)
                    const fileData = this.parseFilePickerData(event.detail);
                    this.selectedFiles = Array.isArray(fileData) ? fileData : [fileData];
                    
                    this.log(`📁 选择了 ${this.selectedFiles.length} 个文件/目录`);
                    this.displaySelectedFiles();
                    this.closeFilePicker();
                } catch (error) {
                    this.log(`❌ 文件数据解析失败: ${error.message}`, 'error');
                }
            }

            /**
             * 解析文件选择器返回的数据
             * @param {any} rawData - 原始数据
             * @returns {Array} 解析后的文件数组
             */
            parseFilePickerData(rawData) {
                if (!rawData || !rawData[0]) {
                    throw new Error('无效的文件数据');
                }

                let fileList;
                try {
                    // 处理可能的 JSON 字符串格式
                    if (typeof rawData[0] === 'string') {
                        fileList = JSON.parse(rawData[0]);
                    } else {
                        fileList = rawData[0];
                    }
                } catch (error) {
                    throw new Error('文件数据格式错误');
                }

                // 确保返回数组格式
                return Array.isArray(fileList) ? fileList : [fileList];
            }

            /**
             * 显示选中的文件
             */
            async displaySelectedFiles() {
                const container = document.getElementById('selectedFiles');
                if (!container || !this.selectedFiles.length) return;

                let html = '<div class="file-list"><h4>📁 已选择的文件</h4>';
                
                for (const file of this.selectedFiles) {
                    html += await this.generateFileItem(file);
                }
                
                html += '</div>';
                container.innerHTML = html;
            }

            /**
             * 生成文件项目HTML
             * @param {Object} file - 文件对象
             * @returns {string} HTML字符串
             */
            async generateFileItem(file) {
                const isImage = this.isImageFile(file);
                const isText = this.isTextFile(file);
                
                let previewHtml = '';
                
                if (isImage) {
                    // 图片预览 - 使用网盘文件路径
                    const imageUrl = this.getCloudFilePreviewUrl(file);
                    previewHtml = `
                        <div class="file-preview">
                            <img src="${imageUrl}" alt="${file.basename}" 
                                 style="max-width: 200px; max-height: 150px; border-radius: 8px;"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div style="display: none; color: #999;">图片加载失败</div>
                        </div>
                    `;
                } else if (isText) {
                    // 文本文件预览 - 使用网盘文件路径
                    try {
                        const textContent = await this.getCloudFileContent(file);
                        previewHtml = `
                            <div class="file-preview">
                                <pre style="max-height: 100px; overflow-y: auto; background: #f5f5f5; padding: 10px; border-radius: 4px;">
                                    ${this.escapeHtml(textContent.substring(0, 500))}${textContent.length > 500 ? '...' : ''}
                                </pre>
                            </div>
                        `;
                    } catch (error) {
                        previewHtml = `
                            <div class="file-preview">
                                <div style="color: #999;">文本内容加载失败</div>
                            </div>
                        `;
                    }
                }

                return `
                    <div class="file-item" data-filename="${file.filename}">
                        <div class="file-info">
                            <div class="file-name">📄 ${file.basename}</div>
                            <div class="file-meta">
                                大小: ${this.formatFileSize(file.size)} | 
                                类型: ${file.mime || '未知'} | 
                                修改时间: ${new Date(file.lastmod).toLocaleString()} |
                                路径: /lzcapp/run/mnt/home/${this.currentUser}${file.filename}
                            </div>
                            ${previewHtml}
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-primary" onclick="filePicker.downloadCloudFile('${file.filename}')">
                                📥 下载
                            </button>
                            ${isImage ? `<button class="btn btn-info" onclick="filePicker.viewFullImage('${file.filename}')">🔍 查看大图</button>` : ''}
                        </div>
                    </div>
                `;
            }

            /**
             * 获取网盘文件预览URL
             * @param {Object} file - 文件对象
             * @returns {string} 预览URL
             */
            getCloudFilePreviewUrl(file) {
                // 构建网盘文件的预览URL
                return `/api/cloud-file/preview?file=${encodeURIComponent(file.filename)}&type=image`;
            }

            /**
             * 获取网盘文件内容
             * @param {Object} file - 文件对象
             * @returns {Promise<string>} 文件内容
             */
            async getCloudFileContent(file) {
                try {
                    const response = await fetch(`/api/cloud-file/content?file=${encodeURIComponent(file.filename)}`);
                    if (response.ok) {
                        const result = await response.json();
                        return result.content || '无法加载文件内容';
                    }
                    return '文件内容加载失败';
                } catch (error) {
                    return '文件内容加载失败';
                }
            }

            /**
             * 下载网盘文件
             * @param {string} filename - 文件名
             */
            async downloadCloudFile(filename) {
                try {
                    this.log(`📥 开始下载网盘文件: ${filename}`);
                    
                    // 构建下载URL - 网盘文件下载
                    const downloadUrl = `/api/cloud-file/download?file=${encodeURIComponent(filename)}`;
                    
                    // 创建下载链接
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = filename.split('/').pop(); // 获取文件名
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    this.log(`✅ 网盘文件下载已启动: ${filename}`, 'success');
                } catch (error) {
                    this.log(`❌ 网盘文件下载失败: ${error.message}`, 'error');
                }
            }

            /**
             * 查看大图
             * @param {string} filename - 文件名
             */
            viewFullImage(filename) {
                const file = this.selectedFiles.find(f => f.filename === filename);
                if (!file) return;

                const modal = document.createElement('div');
                modal.className = 'image-modal';
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.8); z-index: 1000; display: flex;
                    align-items: center; justify-content: center; cursor: pointer;
                `;

                const img = document.createElement('img');
                img.src = this.getCloudFilePreviewUrl(file);
                img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';

                modal.appendChild(img);
                document.body.appendChild(modal);

                modal.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });
            }

            /**
             * 清空选择
             */
            clearSelection() {
                this.selectedFiles = [];
                const container = document.getElementById('selectedFiles');
                if (container) {
                    container.innerHTML = '';
                }
                this.log('🗑️ 已清空文件选择');
            }

            /**
             * 处理文件选择（用于上传）
             * @param {FileList} files - 选择的文件列表
             */
            handleFileSelection(files) {
                this.uploadFileList = Array.from(files);
                this.log(`📤 选择了 ${this.uploadFileList.length} 个文件准备上传`);
                
                // 启用上传按钮
                document.getElementById('uploadToVar').disabled = false;
                document.getElementById('uploadToCache').disabled = false;
                
                // 显示选择的文件信息
                this.displayUploadFiles();
            }

            /**
             * 显示待上传文件
             */
            displayUploadFiles() {
                const statusContainer = document.getElementById('uploadStatus');
                if (!this.uploadFileList.length) return;

                let html = '<div class="file-list"><h4>📤 待上传文件</h4>';
                this.uploadFileList.forEach(file => {
                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-name">📄 ${file.name}</div>
                                <div class="file-meta">
                                    大小: ${this.formatFileSize(file.size)} | 
                                    类型: ${file.type || '未知'}
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                statusContainer.innerHTML = html;
            }

            /**
             * 上传文件
             * @param {string} storageType - 存储类型：'var' 或 'cache'
             */
            async uploadFiles(storageType) {
                if (!this.uploadFileList.length) {
                    this.log('❌ 没有选择要上传的文件', 'error');
                    return;
                }

                this.log(`📤 开始上传 ${this.uploadFileList.length} 个文件到 ${storageType} 目录...`);

                try {
                    const formData = new FormData();
                    this.uploadFileList.forEach(file => {
                        formData.append('files', file);
                    });

                    const response = await fetch(`/api/upload/${storageType}`, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.log(`✅ 文件上传成功: ${result.message}`, 'success');
                        this.displayUploadResult(result);
                        
                        // 清空上传列表
                        this.uploadFileList = [];
                        document.getElementById('uploadToVar').disabled = true;
                        document.getElementById('uploadToCache').disabled = true;
                        document.getElementById('uploadStatus').innerHTML = '';
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    this.log(`❌ 文件上传失败: ${error.message}`, 'error');
                }
            }

            /**
             * 显示上传结果
             * @param {Object} result - 上传结果
             */
            displayUploadResult(result) {
                const statusContainer = document.getElementById('uploadStatus');
                let html = `
                    <div class="status success">
                        <strong>✅ ${result.message}</strong>
                        <div>存储路径: ${result.storageInfo.uploadPath}</div>
                    </div>
                    <div class="file-list">
                `;

                result.files.forEach(file => {
                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-name">📄 ${file.originalName}</div>
                                <div class="file-meta">
                                    大小: ${this.formatFileSize(file.size)} | 
                                    存储名: ${file.filename} |
                                    存储路径: ${file.storagePath}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                statusContainer.innerHTML = html;
            }

            /**
             * 列出文件
             * @param {string} storageType - 存储类型
             */
            async listFiles(storageType) {
                this.log(`📋 获取 ${storageType} 目录文件列表...`);

                try {
                    const response = await fetch(`/api/files/${storageType}`);
                    const result = await response.json();

                    if (result.success) {
                        this.log(`✅ 获取到 ${result.files.length} 个文件`);
                        this.displayFileList(result.files, storageType);
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    this.log(`❌ 获取文件列表失败: ${error.message}`, 'error');
                }
            }

            /**
             * 显示文件列表
             * @param {Array} files - 文件列表
             * @param {string} storageType - 存储类型
             */
            displayFileList(files, storageType) {
                const container = document.getElementById('fileManagement');
                
                let html = `<div class="file-list"><h4>📋 ${storageType.toUpperCase()} 目录文件列表</h4>`;
                
                if (files.length === 0) {
                    html += '<div class="status info">📁 目录为空</div>';
                } else {
                    files.forEach(file => {
                        html += `
                            <div class="file-item">
                                <div class="file-info">
                                    <div class="file-name">📄 ${file.filename}</div>
                                    <div class="file-meta">
                                        大小: ${this.formatFileSize(file.size)} | 
                                        上传时间: ${new Date(file.uploadTime).toLocaleString()}
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <button class="btn btn-primary" onclick="filePicker.deleteFile('${storageType}', '${file.filename}')">
                                        🗑️ 删除
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                container.innerHTML = html;
            }

            /**
             * 删除文件
             * @param {string} storageType - 存储类型
             * @param {string} filename - 文件名
             */
            async deleteFile(storageType, filename) {
                if (!confirm(`确定要删除文件 ${filename} 吗？`)) {
                    return;
                }

                try {
                    const response = await fetch(`/api/files/${storageType}/${filename}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.log(`✅ 文件删除成功: ${filename}`, 'success');
                        // 刷新文件列表
                        this.listFiles(storageType);
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    this.log(`❌ 文件删除失败: ${error.message}`, 'error');
                }
            }

            // 工具方法
            isImageFile(file) {
                const imageTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                return imageTypes.includes(file.mime) || /\.(jpg|jpeg|png|gif|webp)$/i.test(file.basename);
            }

            isTextFile(file) {
                const textTypes = ['text/plain', 'text/html', 'text/css', 'text/javascript', 'application/json'];
                return textTypes.includes(file.mime) || /\.(txt|html|css|js|json|md)$/i.test(file.basename);
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            log(message, level = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[LazycatFilePicker] ${message}`);
                
                // 如果有日志容器，也显示在页面上
                if (this.logContainer) {
                    const logEntry = document.createElement('div');
                    logEntry.textContent = `[${timestamp}] ${message}`;
                    logEntry.className = `log-entry log-${level}`;
                    this.logContainer.appendChild(logEntry);
                    this.logContainer.scrollTop = this.logContainer.scrollHeight;
                }
            }
        }

        // 全局实例
        const filePicker = new LazycatFilePickerTester();
    </script>
</body>
</html>