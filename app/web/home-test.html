<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homeç›®å½•æ–‡ä»¶ä¿å­˜å¢å¼ºæµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5;
        }
        .test-container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section { 
            border: 1px solid #ddd; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            background: #fafafa;
        }
        .debug-log { 
            background: #f5f5f5; 
            padding: 15px; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace; 
            white-space: pre-wrap; 
            max-height: 500px; 
            overflow-y: auto; 
            border: 1px solid #ccc;
            font-size: 12px;
            line-height: 1.4;
        }
        .btn { 
            padding: 12px 20px; 
            margin: 8px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn:hover { transform: translateY(-1px); }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
            transform: none;
        }
        .status { 
            padding: 12px; 
            margin: 10px 0; 
            border-radius: 6px; 
            border-left: 4px solid;
        }
        .status.success { 
            background: #d4edda; 
            color: #155724; 
            border-left-color: #28a745;
        }
        .status.error { 
            background: #f8d7da; 
            color: #721c24; 
            border-left-color: #dc3545;
        }
        .status.info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border-left-color: #17a2b8;
        }
        .status.warning { 
            background: #fff3cd; 
            color: #856404; 
            border-left-color: #ffc107;
        }
        .iframe-container { 
            border: 2px solid #007bff; 
            height: 600px; 
            margin: 15px 0; 
            border-radius: 8px;
            overflow: hidden;
        }
        .technical-info { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 6px; 
            margin: 15px 0; 
            border: 1px solid #dee2e6;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        h2 { color: #495057; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h3 { color: #6c757d; }
        .file-info {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
    </style>
    <!-- å¼•å…¥æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶ [citation](5) -->
    <script defer src="https://unpkg.com/@lazycatcloud/lzc-file-pickers@latest/dist/lzc-file-pickers.umd.js"></script>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ  Homeç›®å½•æ–‡ä»¶ä¿å­˜å¢å¼ºæµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>ğŸ“Š ç¯å¢ƒä¿¡æ¯</h2>
            <div id="envInfo">æ­£åœ¨åŠ è½½ç¯å¢ƒä¿¡æ¯...</div>
            <div class="technical-info">
                <h4>ğŸ”§ æŠ€æœ¯è¯Šæ–­ä¿¡æ¯</h4>
                <div id="technicalInfo">æ­£åœ¨è¯Šæ–­...</div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“ æµ‹è¯•æ–‡ä»¶é€‰æ‹©</h2>
            <input type="file" id="testFileInput" style="display: none;" accept="image/*,application/pdf,.txt,.doc,.docx,.zip">
            <div class="button-group">
                <button id="selectTestFile" class="btn btn-primary">ğŸ“‚ é€‰æ‹©æµ‹è¯•æ–‡ä»¶</button>
            </div>
            <div id="selectedFileInfo" class="file-info" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>ğŸš€ æ–‡ä»¶ä¿å­˜å™¨æµ‹è¯•</h2>
            <div class="button-group">
                <button id="testBasicSaveAs" class="btn btn-success">ğŸ”§ åŸºç¡€ä¿å­˜å™¨æµ‹è¯•</button>
                <button id="testAdvancedSaveAs" class="btn btn-warning">âš¡ å¢å¼ºä¿å­˜å™¨æµ‹è¯•</button>
                <button id="testFixedSaveAs" class="btn btn-info">ğŸ› ï¸ ä¿®æ­£ç‰ˆä¿å­˜å™¨æµ‹è¯•</button>
                <button id="testFileWithSaveAs" class="btn btn-primary" disabled>ğŸ’¾ ä¿å­˜é€‰ä¸­æ–‡ä»¶</button>
                <button id="testFixedFileWithSaveAs" class="btn btn-info" disabled>ğŸ”§ ä¿®æ­£ç‰ˆæ–‡ä»¶ä¿å­˜</button>
                <button id="testDirectAPI" class="btn btn-danger">ğŸ”— ç›´æ¥APIæµ‹è¯•</button>
            </div>
            
            <!-- æ–‡ä»¶ä¿å­˜å™¨å®¹å™¨ -->
            <div id="saveAsContainer" style="display: none; margin-top: 20px;">
                <h3>ğŸ“‹ æ–‡ä»¶ä¿å­˜å™¨ç•Œé¢</h3>
                <div id="saveAsWrapper" class="iframe-container"></div>
                <div class="button-group">
                    <button id="closeSaveAs" class="btn btn-secondary">âŒ å…³é—­ä¿å­˜å™¨</button>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“ˆ å®æ—¶çŠ¶æ€ç›‘æ§</h2>
            <div id="statusContainer"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ› è¯¦ç»†è°ƒè¯•æ—¥å¿—</h2>
            <div class="button-group">
                <button id="clearLog" class="btn btn-secondary">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                <button id="exportLog" class="btn btn-info">ğŸ“¤ å¯¼å‡ºæ—¥å¿—</button>
                <button id="toggleAutoScroll" class="btn btn-warning">ğŸ“œ åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨</button>
            </div>
            <div id="debugLog" class="debug-log"></div>
        </div>
    </div>

    <script>
        class EnhancedHomeDirectoryTester {
            constructor() {
                this.lazycatEnv = null;
                this.selectedFile = null;
                this.currentSaveAs = null;
                this.debugLog = document.getElementById('debugLog');
                this.initStartTime = Date.now();
                this.autoScroll = true;
                
                this.init();
            }

            async init() {
                this.log('=== ğŸš€ å¯åŠ¨å¢å¼ºç‰ˆ Home ç›®å½•æµ‹è¯•å™¨ ===');
                
                try {
                    // åŠ è½½ç¯å¢ƒä¿¡æ¯
                    await this.loadEnvironment();
                    
                    // æŠ€æœ¯è¯Šæ–­
                    await this.performTechnicalDiagnosis();
                    
                    // ç»‘å®šäº‹ä»¶
                    this.bindEvents();
                    
                    this.log('âœ… å¢å¼ºç‰ˆ Home ç›®å½•æµ‹è¯•å™¨åˆå§‹åŒ–å®Œæˆ');
                } catch (error) {
                    this.log('âŒ åˆå§‹åŒ–å¤±è´¥', error.message, 'error');
                }
            }

            async loadEnvironment() {
                try {
                    const response = await fetch('/api/lazycat-env');
                    const result = await response.json();
                    
                    if (result.success) {
                        this.lazycatEnv = result.environment;
                        this.displayEnvironmentInfo();
                        this.log('âœ… ç¯å¢ƒä¿¡æ¯åŠ è½½æˆåŠŸ', this.lazycatEnv);
                    } else {
                        throw new Error('æ— æ³•è·å–ç¯å¢ƒä¿¡æ¯');
                    }
                } catch (error) {
                    this.log('âŒ ç¯å¢ƒä¿¡æ¯åŠ è½½å¤±è´¥', error.message, 'error');
                    throw error;
                }
            }

            async performTechnicalDiagnosis() {
                this.log('ğŸ” å¼€å§‹æŠ€æœ¯è¯Šæ–­...');
                
                const diagnosis = {
                    'æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶': 'unknown',
                    'iframeé€šä¿¡æœºåˆ¶': 'unknown',
                    'æ–‡ä»¶æœåŠ¡å™¨è¿é€šæ€§': 'unknown',
                    'postMessageæ”¯æŒ': 'unknown',
                    'ç”¨æˆ·æƒé™çŠ¶æ€': 'unknown',
                    'CustomElementsæ”¯æŒ': 'unknown'
                };

                // æ£€æŸ¥æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶ [citation](1)
                try {
                    if (typeof customElements !== 'undefined' && customElements.get('lzc-file-picker')) {
                        diagnosis['æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶'] = 'âœ… å·²åŠ è½½';
                    } else {
                        diagnosis['æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶'] = 'âŒ æœªåŠ è½½';
                    }
                } catch (error) {
                    diagnosis['æ‡’çŒ«æ–‡ä»¶é€‰æ‹©å™¨æ’ä»¶'] = 'âŒ æ£€æŸ¥å¤±è´¥: ' + error.message;
                }

                // æ£€æŸ¥ CustomElements æ”¯æŒ
                try {
                    if (typeof customElements !== 'undefined') {
                        diagnosis['CustomElementsæ”¯æŒ'] = 'âœ… æ”¯æŒ';
                    } else {
                        diagnosis['CustomElementsæ”¯æŒ'] = 'âŒ ä¸æ”¯æŒ';
                    }
                } catch (error) {
                    diagnosis['CustomElementsæ”¯æŒ'] = 'âŒ æ£€æŸ¥å¤±è´¥';
                }

                // æ£€æŸ¥ postMessage æ”¯æŒ
                try {
                    if (typeof window.postMessage === 'function') {
                        diagnosis['postMessageæ”¯æŒ'] = 'âœ… æ”¯æŒ';
                    } else {
                        diagnosis['postMessageæ”¯æŒ'] = 'âŒ ä¸æ”¯æŒ';
                    }
                } catch (error) {
                    diagnosis['postMessageæ”¯æŒ'] = 'âŒ æ£€æŸ¥å¤±è´¥';
                }

                // æ£€æŸ¥æ–‡ä»¶æœåŠ¡å™¨è¿é€šæ€§
                try {
                    if (this.lazycatEnv && this.lazycatEnv.filePickerDomain) {
                        diagnosis['æ–‡ä»¶æœåŠ¡å™¨è¿é€šæ€§'] = 'âœ… åŸŸåå¯è®¿é—®';
                    }
                } catch (error) {
                    diagnosis['æ–‡ä»¶æœåŠ¡å™¨è¿é€šæ€§'] = 'âŒ è¿æ¥å¤±è´¥: ' + error.message;
                }

                // æ£€æŸ¥ç”¨æˆ·æƒé™
                try {
                    const userResponse = await fetch('/api/user-info');
                    const userResult = await userResponse.json();
                    if (userResult.success) {
                        diagnosis['ç”¨æˆ·æƒé™çŠ¶æ€'] = `âœ… ç”¨æˆ·: ${userResult.user.id}, è§’è‰²: ${userResult.user.role}`;
                    }
                } catch (error) {
                    diagnosis['ç”¨æˆ·æƒé™çŠ¶æ€'] = 'âŒ è·å–å¤±è´¥: ' + error.message;
                }

                this.displayTechnicalInfo(diagnosis);
                this.log('ğŸ” æŠ€æœ¯è¯Šæ–­å®Œæˆ', diagnosis);
            }

            displayEnvironmentInfo() {
                const envInfo = document.getElementById('envInfo');
                envInfo.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                        <div><strong>ğŸ·ï¸ è®¾å¤‡åç§°:</strong> ${this.lazycatEnv.boxName}</div>
                        <div><strong>ğŸŒ æ–‡ä»¶é€‰æ‹©å™¨åŸŸå:</strong> ${this.lazycatEnv.filePickerDomain}</div>
                        <div><strong>ğŸ“ Homeç›®å½•è·¯å¾„:</strong> /lzcapp/run/mnt/home</div>
                        <div><strong>ğŸ”— åº”ç”¨åŸŸå:</strong> ${this.lazycatEnv.appDomain}</div>
                    </div>
                `;
            }

            displayTechnicalInfo(diagnosis) {
                const techInfo = document.getElementById('technicalInfo');
                let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">';
                for (const [key, value] of Object.entries(diagnosis)) {
                    const isError = value.includes('âŒ') || value.includes('å¤±è´¥') || value.includes('ä¸æ”¯æŒ') || value === 'unknown';
                    const statusClass = isError ? 'error' : 'success';
                    html += `<div><strong>${key}:</strong> <span class="status ${statusClass}" style="display: inline; padding: 4px 8px; margin-left: 5px;">${value}</span></div>`;
                }
                html += '</div>';
                techInfo.innerHTML = html;
            }

            bindEvents() {
                // æ–‡ä»¶é€‰æ‹©
                document.getElementById('selectTestFile').addEventListener('click', () => {
                    document.getElementById('testFileInput').click();
                });

                document.getElementById('testFileInput').addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        this.selectedFile = e.target.files[0];
                        this.displaySelectedFile();
                        document.getElementById('testFileWithSaveAs').disabled = false;
                        document.getElementById('testFixedFileWithSaveAs').disabled = false;
                    }
                });

                // æµ‹è¯•æŒ‰é’®
                document.getElementById('testBasicSaveAs').addEventListener('click', () => {
                    this.testBasicSaveAs();
                });

                document.getElementById('testAdvancedSaveAs').addEventListener('click', () => {
                    this.testAdvancedSaveAs();
                });

                document.getElementById('testFixedSaveAs').addEventListener('click', () => {
                    this.testBasicSaveAsFixed();
                });

                document.getElementById('testFileWithSaveAs').addEventListener('click', () => {
                    this.testFileWithSaveAs();
                });

                document.getElementById('testFixedFileWithSaveAs').addEventListener('click', () => {
                    this.testFileWithSaveAsFixed();
                });

                document.getElementById('testDirectAPI').addEventListener('click', () => {
                    this.testDirectAPI();
                });

                document.getElementById('closeSaveAs').addEventListener('click', () => {
                    this.closeSaveAs();
                });

                // æ—¥å¿—æ“ä½œ
                document.getElementById('clearLog').addEventListener('click', () => {
                    this.debugLog.textContent = '';
                });

                document.getElementById('exportLog').addEventListener('click', () => {
                    this.exportLog();
                });

                document.getElementById('toggleAutoScroll').addEventListener('click', () => {
                    this.autoScroll = !this.autoScroll;
                    this.showStatus(`è‡ªåŠ¨æ»šåŠ¨å·²${this.autoScroll ? 'å¼€å¯' : 'å…³é—­'}`, 'info');
                });
            }

            displaySelectedFile() {
                const info = document.getElementById('selectedFileInfo');
                info.style.display = 'block';
                info.innerHTML = `
                    <h4>ğŸ“„ å·²é€‰æ‹©æ–‡ä»¶ä¿¡æ¯</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <div><strong>æ–‡ä»¶å:</strong> ${this.selectedFile.name}</div>
                        <div><strong>æ–‡ä»¶å¤§å°:</strong> ${(this.selectedFile.size / 1024 / 1024).toFixed(2)} MB</div>
                        <div><strong>æ–‡ä»¶ç±»å‹:</strong> ${this.selectedFile.type}</div>
                        <div><strong>æœ€åä¿®æ”¹:</strong> ${new Date(this.selectedFile.lastModified).toLocaleString()}</div>
                    </div>
                `;
                this.log('ğŸ“„ æ–‡ä»¶é€‰æ‹©å®Œæˆ', {
                    name: this.selectedFile.name,
                    size: this.selectedFile.size,
                    type: this.selectedFile.type,
                    lastModified: this.selectedFile.lastModified
                });
            }

            // åŸºç¡€æ–‡ä»¶ä¿å­˜å™¨æµ‹è¯• [citation](5)
            testBasicSaveAs() {
                this.log('=== ğŸ”§ å¼€å§‹åŸºç¡€æ–‡ä»¶ä¿å­˜å™¨æµ‹è¯• ===');
                
                try {
                    const saveAs = this.createSaveAsElement('åŸºç¡€ä¿å­˜å™¨æµ‹è¯•');
                    this.setupSaveAsEvents(saveAs);
                    this.displaySaveAs(saveAs);
                    
                    // ä½¿ç”¨æ ‡å‡†åˆå§‹åŒ–æ–¹æ³•
                    setTimeout(() => {
                        this.initSaveAsWithStandardMethod(saveAs, 'è¿™æ˜¯åŸºç¡€æµ‹è¯•å†…å®¹\næ—¶é—´: ' + new Date().toISOString());
                    }, 1000);
                    
                } catch (error) {
                    this.log('âŒ åˆ›å»ºåŸºç¡€æ–‡ä»¶ä¿å­˜å™¨å¤±è´¥', error.message, 'error');
                    this.showStatus('åˆ›å»ºåŸºç¡€æ–‡ä»¶ä¿å­˜å™¨å¤±è´¥: ' + error.message, 'error');
                }
            }

            // å¢å¼ºæ–‡ä»¶ä¿å­˜å™¨æµ‹è¯•
            testAdvancedSaveAs() {
                this.log('=== âš¡ å¼€å§‹å¢å¼ºæ–‡ä»¶ä¿å­˜å™¨æµ‹è¯• ===');
                
                try {
                    const saveAs = this.createSaveAsElement('å¢å¼ºä¿å­˜å™¨æµ‹è¯•');
                    this.setupAdvancedSaveAsEvents(saveAs);
                    this.displaySaveAs(saveAs);
                    
                    // ä½¿ç”¨å¤šé‡åˆå§‹åŒ–ç­–ç•¥
                    setTimeout(() => {
                        this.initSaveAsWithMultipleStrategies(saveAs, 'è¿™æ˜¯å¢å¼ºæµ‹è¯•å†…å®¹\nåŒ…å«æ›´å¤šè°ƒè¯•ä¿¡æ¯\næ—¶é—´: ' + new Date().toISOString());
                    }, 1500);
                    
                } catch (error) {
                    this.log('âŒ åˆ›å»ºå¢å¼ºæ–‡ä»¶ä¿å­˜å™¨å¤±è´¥', error.message, 'error');
                    this.showStatus('åˆ›å»ºå¢å¼ºæ–‡ä»¶ä¿å­˜å™¨å¤±è´¥: ' + error.message, 'error');
                }
            }

            // ä¿®æ­£ç‰ˆåŸºç¡€ä¿å­˜å™¨æµ‹è¯•
            testBasicSaveAsFixed() {
                this.log('=== ğŸ› ï¸ å¼€å§‹ä¿®æ­£ç‰ˆåŸºç¡€æ–‡ä»¶ä¿å­˜å™¨æµ‹è¯• ===');
                
                try {
                    const saveAs = this.createSaveAsElement('ä¿®æ­£ç‰ˆåŸºç¡€ä¿å­˜å™¨');
                    this.setupSaveAsEvents(saveAs);
                    this.displaySaveAs(saveAs);
                    
                    // ä½¿ç”¨äº‹ä»¶é©±åŠ¨åˆå§‹åŒ–
                    setTimeout(async () => {
                        try {
                            await this.initSaveAsWithCorrectFlow(
                                saveAs, 
                                'è¿™æ˜¯ä¿®æ­£ç‰ˆæµ‹è¯•å†…å®¹\næ—¶é—´: ' + new Date().toISOString(),
                                'txt',
                                'ä¿®æ­£ç‰ˆæµ‹è¯•æ–‡ä»¶'
                            );
                        } catch (error) {
                            this.log('âŒ ä¿®æ­£ç‰ˆåˆå§‹åŒ–å¤±è´¥', error.message, 'error');
                        }
                    }, 500);
                    
                } catch (error) {
                    this.log('âŒ åˆ›å»ºä¿®æ­£ç‰ˆæ–‡ä»¶ä¿å­˜å™¨å¤±è´¥', error.message, 'error');
                    this.showStatus('åˆ›å»ºä¿®æ­£ç‰ˆæ–‡ä»¶ä¿å­˜å™¨å¤±è´¥: ' + error.message, 'error');
                }
            }

            // æ ‡å‡†æ–‡ä»¶ä¿å­˜æµ‹è¯•
            testFileWithSaveAs() {
                if (!this.selectedFile) {
                    this.showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', 'error');
                    return;
                }

                this.log('ğŸ’¾ å¼€å§‹æ ‡å‡†æ–‡ä»¶ä¿å­˜:', this.selectedFile.name);
                this.processFileForSaving(this.selectedFile, false);
            }

            // ä¿®æ­£ç‰ˆæ–‡ä»¶ä¿å­˜æµ‹è¯•
            testFileWithSaveAsFixed() {
                if (!this.selectedFile) {
                    this.showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶', 'error');
                    return;
                }

                this.log('ğŸ”§ å¼€å§‹ä¿®æ­£ç‰ˆæ–‡ä»¶ä¿å­˜:', this.selectedFile.name);

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const saveAs = this.createSaveAsElement(`ä¿å­˜æ–‡ä»¶: ${this.selectedFile.name}`);
                        
                        // è®¾ç½®æ­£ç¡®çš„äº‹ä»¶ç›‘å¬ [citation](5)
                        saveAs.addEventListener('done', (event) => {
                            const result = event.detail[0];
                            this.log('ğŸ‰ æ–‡ä»¶ä¿å­˜æˆåŠŸ!', result, 'success');
                            
                            // æ£€æŸ¥ä¿å­˜çŠ¶æ€
                            if (result.status) {
                                result.status.then((success) => {
                                    if (success) {
                                        this.showStatus(`æ–‡ä»¶ ${this.selectedFile.name} å·²æˆåŠŸä¿å­˜åˆ°ç”¨æˆ·ç½‘ç›˜!`, 'success');
                                    } else {
                                        this.showStatus('æ–‡ä»¶ä¿å­˜å¤±è´¥', 'error');
                                    }
                                });
                            }
                            
                            this.closeSaveAs();
                        });

                        saveAs.addEventListener('close', () => {
                            this.log('ç”¨æˆ·å–æ¶ˆäº†ä¿å­˜æ“ä½œ');
                            this.closeSaveAs();
                        });

                        this.displaySaveAs(saveAs);

                        // å¤„ç†æ–‡ä»¶å†…å®¹
                        let content;
                        const fileExtension = this.selectedFile.name.split('.').pop() || 'txt';
                        const fileName = this.selectedFile.name.replace(/\.[^/.]+$/, "");

                        if (this.selectedFile.type.startsWith('text/')) {
                            content = e.target.result;
                        } else {
                            // å¯¹äºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä½¿ç”¨ base64 ç¼–ç 
                            content = e.target.result.split(',')[1];
                        }

                        // ä½¿ç”¨ä¿®æ­£çš„åˆå§‹åŒ–æ–¹æ³•
                        setTimeout(async () => {
                            try {
                                await this.initSaveAsWithCorrectFlow(
                                    saveAs, 
                                    content, 
                                    fileExtension, 
                                    fileName
                                );
                            } catch (error) {
                                this.log('âŒ æ–‡ä»¶ä¿å­˜åˆå§‹åŒ–å¤±è´¥', error.message, 'error');
                                this.showStatus('æ–‡ä»¶ä¿å­˜åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                            }
                        }, 1000); // ç»™è¶³å¤Ÿæ—¶é—´è®©ç»„ä»¶å®Œå…¨åŠ è½½

                    } catch (error) {
                        this.log('âŒ å¤„ç†æ–‡ä»¶å¤±è´¥', error.message, 'error');
                        this.showStatus('å¤„ç†æ–‡ä»¶å¤±è´¥: ' + error.message, 'error');
                    }
                };

                reader.onerror = () => {
                    this.log('âŒ è¯»å–æ–‡ä»¶å¤±è´¥', '', 'error');
                    this.showStatus('è¯»å–æ–‡ä»¶å¤±è´¥', 'error');
                };

                // æ ¹æ®æ–‡ä»¶ç±»å‹é€‰æ‹©è¯»å–æ–¹å¼
                if (this.selectedFile.type.startsWith('text/')) {
                    reader.readAsText(this.selectedFile);
                } else {
                    reader.readAsDataURL(this.selectedFile);
                }
            }

            // ç›´æ¥APIæµ‹è¯•
            async testDirectAPI() {
                this.log('=== ğŸ”— å¼€å§‹ç›´æ¥APIæµ‹è¯• ===');
                
                if (!this.selectedFile) {
                    this.showStatus('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶è¿›è¡ŒAPIæµ‹è¯•', 'error');
                    return;
                }

                try {
                    const formData = new FormData();
                    formData.append('files', this.selectedFile);
                    formData.append('storageType', 'var'); // å¼ºåˆ¶ä½¿ç”¨ var å­˜å‚¨

                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        this.log('âœ… ç›´æ¥APIæµ‹è¯•æˆåŠŸ', result, 'success');
                        this.showStatus('ç›´æ¥APIä¸Šä¼ æˆåŠŸï¼Œæ–‡ä»¶å·²ä¿å­˜åˆ° var ç›®å½•', 'success');
                    } else {
                        throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
                    }
                } catch (error) {
                    this.log('âŒ ç›´æ¥APIæµ‹è¯•å¤±è´¥', error.message, 'error');
                    this.showStatus('ç›´æ¥APIæµ‹è¯•å¤±è´¥: ' + error.message, 'error');
                }
            }

            // æ ¸å¿ƒæ–¹æ³•ï¼šä¿®æ­£ç‰ˆåˆå§‹åŒ–æµç¨‹ [citation](5)
            async initSaveAsWithCorrectFlow(saveAs, content, extension = 'txt', filename = null) {
                return new Promise((resolve, reject) => {
                    this.log('ğŸ¯ å¼€å§‹äº‹ä»¶é©±åŠ¨åˆå§‹åŒ–...');
                    
                    const maxRetries = 60; // å¢åŠ é‡è¯•æ¬¡æ•°
                    let retryCount = 0;
                    const retryInterval = 500; // é‡è¯•é—´éš”

                    const tryInit = () => {
                        try {
                            this.log(`ğŸ”„ é‡è¯•åˆå§‹åŒ– (${retryCount + 1}/${maxRetries})`);

                            // è¯¦ç»†æ£€æŸ¥æ¯ä¸ªæ­¥éª¤
                            if (!saveAs) {
                                throw new Error('saveAs å…ƒç´ ä¸å­˜åœ¨');
                            }

                            // æ£€æŸ¥ _instance æ˜¯å¦å­˜åœ¨
                            if (!saveAs._instance) {
                                retryCount++;
                                if (retryCount < maxRetries) {
                                    this.log('â³ _instance æœªå°±ç»ªï¼Œç»§ç»­ç­‰å¾…...');
                                    setTimeout(tryInit, retryInterval);
                                    return;
                                } else {
                                    throw new Error('_instance åˆå§‹åŒ–è¶…æ—¶');
                                }
                            }

                            // æ£€æŸ¥ exposed å¯¹è±¡
                            if (!saveAs._instance.exposed) {
                                retryCount++;
                                if (retryCount < maxRetries) {
                                    this.log('â³ exposed å¯¹è±¡æœªå°±ç»ªï¼Œç»§ç»­ç­‰å¾…...');
                                    setTimeout(tryInit, retryInterval);
                                    return;
                                } else {
                                    throw new Error('exposed å¯¹è±¡åˆå§‹åŒ–è¶…æ—¶');
                                }
                            }

                            const ctx = saveAs._instance.exposed;
                            this.log('âœ… æˆåŠŸè·å– exposed å¯¹è±¡');

                            // éªŒè¯æ‰€æœ‰å¿…éœ€æ–¹æ³• [citation](5)
                            const requiredMethods = ['init', 'sendSaveAsData', 'open'];
                            const methodStatus = {};
                            
                            requiredMethods.forEach(method => {
                                methodStatus[method] = typeof ctx[method] === 'function';
                            });

                            this.log('ğŸ” æ–¹æ³•å¯ç”¨æ€§æ£€æŸ¥', methodStatus);

                            if (!methodStatus.init || !methodStatus.sendSaveAsData || !methodStatus.open) {
                                throw new Error('å¿…éœ€æ–¹æ³•ä¸å®Œæ•´: ' + JSON.stringify(methodStatus));
                            }

                            // æ‰§è¡Œåˆå§‹åŒ–åºåˆ— [citation](5)
                            this.log('ğŸš€ å¼€å§‹æ‰§è¡Œåˆå§‹åŒ–åºåˆ—...');
                            
                            // 1. åˆå§‹åŒ–åˆ° home ç›®å½•
                            ctx.init('/lzcapp/run/mnt/home');
                            this.log('âœ… init æ–¹æ³•è°ƒç”¨æˆåŠŸ');

                            // 2. å‘é€æ–‡ä»¶å†…å®¹å’Œæ–‡ä»¶å [citation](5)
                            const finalFilename = filename || `ä¿å­˜æ–‡ä»¶-${Date.now()}`;
                            ctx.sendSaveAsData(content, extension, finalFilename);
                            this.log('âœ… sendSaveAsData æ–¹æ³•è°ƒç”¨æˆåŠŸ', {
                                extension: extension,
                                filename: finalFilename,
                                contentLength: content.length
                            });

                            // 3. æ‰“å¼€ä¿å­˜å™¨
                            ctx.open();
                            this.log('âœ… open æ–¹æ³•è°ƒç”¨æˆåŠŸ');

                            this.showStatus('æ–‡ä»¶ä¿å­˜å™¨åˆå§‹åŒ–æˆåŠŸï¼è¯·åœ¨å¼¹å‡ºçš„çª—å£ä¸­é€‰æ‹©ä¿å­˜ä½ç½®å¹¶ç¡®è®¤æ–‡ä»¶å', 'success');
                            resolve(ctx);

                        } catch (error) {
                            this.log('âŒ åˆå§‹åŒ–å¤±è´¥', error.message, 'error');
                            
                            retryCount++;
                            if (retryCount < maxRetries) {
                                setTimeout(tryInit, retryInterval);
                            } else {
                                this.showStatus('æ–‡ä»¶ä¿å­˜å™¨åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                                reject(error);
                            }
                        }
                    };

                    tryInit();
                });
            }

            // æ ‡å‡†åˆå§‹åŒ–æ–¹æ³•
            initSaveAsWithStandardMethod(saveAs, content, extension = 'txt', filename = null) {
                const maxRetries = 30;
                let retryCount = 0;

                const tryInit = () => {
                    try {
                        this.log(`æ ‡å‡†åˆå§‹åŒ–å°è¯• (${retryCount + 1}/${maxRetries})`);

                        if (!saveAs._instance || !saveAs._instance.exposed) {
                            retryCount++;
                            if (retryCount < maxRetries) {
                                setTimeout(tryInit, 500);
                                return;
                            } else {
                                throw new Error('æ ‡å‡†åˆå§‹åŒ–è¶…æ—¶');
                            }
                        }

                        const ctx = saveAs._instance.exposed;
                        ctx.init('/lzcapp/run/mnt/home');
                        ctx.sendSaveAsData(content, extension, filename || `æµ‹è¯•æ–‡ä»¶-${Date.now()}`);
                        ctx.open();

                        this.log('âœ… æ ‡å‡†åˆå§‹åŒ–æˆåŠŸ');
                        this.showStatus('æ ‡å‡†æ–‡ä»¶ä¿å­˜å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');

                    } catch (error) {
                        this.log('âŒ æ ‡å‡†åˆå§‹åŒ–å¤±è´¥', error.message, 'error');
                        this.showStatus('æ ‡å‡†åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                    }
                };

                tryInit();
            }

            // å¤šé‡ç­–ç•¥åˆå§‹åŒ–æ–¹æ³•
            initSaveAsWithMultipleStrategies(saveAs, content, extension = 'txt', filename = null) {
                this.log('=== ğŸ¯ å¼€å§‹å¤šé‡ç­–ç•¥åˆå§‹åŒ– ===');
                
                // ç­–ç•¥1: æ ‡å‡†åˆå§‹åŒ–
                setTimeout(() => {
                    this.log('ğŸ¯ å°è¯•ç­–ç•¥1: æ ‡å‡†åˆå§‹åŒ–');
                    this.initSaveAsWithStandardMethod(saveAs, content, extension, filename);
                }, 1000);

                // ç­–ç•¥2: å»¶è¿Ÿåˆå§‹åŒ–
                setTimeout(() => {
                    this.log('ğŸ¯ å°è¯•ç­–ç•¥2: å»¶è¿Ÿåˆå§‹åŒ–');
                    this.initSaveAsWithStandardMethod(saveAs, content, extension, filename);
                }, 2000);

                // ç­–ç•¥3: äº‹ä»¶é©±åŠ¨åˆå§‹åŒ–
                setTimeout(async () => {
                    this.log('ğŸ¯ å°è¯•ç­–ç•¥3: äº‹ä»¶é©±åŠ¨åˆå§‹åŒ–');
                    try {
                        await this.initSaveAsWithCorrectFlow(saveAs, content, extension, filename);
                    } catch (error) {
                        this.log('âŒ ç­–ç•¥3å¤±è´¥', error.message, 'error');
                    }
                }, 3000);
            }

            // åˆ›å»ºæ–‡ä»¶ä¿å­˜å™¨å…ƒç´  [citation](1)
            createSaveAsElement(title) {
                const saveAs = document.createElement('lzc-file-picker');
                saveAs.setAttribute('type', 'saveAs');
                saveAs.setAttribute('box-id', this.lazycatEnv.boxName);
                saveAs.setAttribute('write-file-content', '');
                saveAs.setAttribute('title', title);
                saveAs.setAttribute('confirm-button-title', 'ä¿å­˜åˆ°ç½‘ç›˜');
                saveAs.setAttribute('breadcrumb-root-title', 'æ ¹ç›®å½•');

                this.log('ğŸ”§ æ–‡ä»¶ä¿å­˜å™¨å…ƒç´ åˆ›å»ºå®Œæˆ', {
                    'box-id': this.lazycatEnv.boxName,
                    type: 'saveAs',
                    title: title
                });

                return saveAs;
            }

            // è®¾ç½®åŸºç¡€äº‹ä»¶ç›‘å¬ [citation](5)
            setupSaveAsEvents(saveAs) {
                saveAs.addEventListener('done', (event) => {
                    const result = event.detail[0];
                    this.log('ğŸ‰ æ–‡ä»¶ä¿å­˜æˆåŠŸ!', result, 'success');
                    this.showStatus('æ–‡ä»¶ä¿å­˜æˆåŠŸ!', 'success');
                    this.closeSaveAs();
                });

                saveAs.addEventListener('close', () => {
                    this.log('ç”¨æˆ·å…³é—­äº†ä¿å­˜å™¨');
                    this.closeSaveAs();
                });

                saveAs.addEventListener('submit', (event) => {
                    this.log('ğŸ“¤ ä¿å­˜å™¨æäº¤äº‹ä»¶', event.detail);
                });
            }

            // è®¾ç½®å¢å¼ºäº‹ä»¶ç›‘å¬
            setupAdvancedSaveAsEvents(saveAs) {
                this.setupSaveAsEvents(saveAs);

                // æ·»åŠ æ›´å¤šäº‹ä»¶ç›‘å¬
                saveAs.addEventListener('visible', (event) => {
                    this.log('ğŸ‘ï¸ ä¿å­˜å™¨å¯è§æ€§å˜åŒ–', event.detail);
                });

                // ç›‘å¬ iframe åŠ è½½äº‹ä»¶
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList') {
                            const iframe = saveAs.querySelector('iframe');
                            if (iframe) {
                                this.log('ğŸ–¼ï¸ æ£€æµ‹åˆ° iframe å…ƒç´ ');
                                iframe.addEventListener('load', () => {
                                    this.log('âœ… iframe åŠ è½½å®Œæˆ');
                                });
                            }
                        }
                    });
                });

                observer.observe(saveAs, { childList: true, subtree: true });
            }

            // æ˜¾ç¤ºæ–‡ä»¶ä¿å­˜å™¨
            displaySaveAs(saveAs) {
                const wrapper = document.getElementById('saveAsWrapper');
                wrapper.innerHTML = '';
                wrapper.appendChild(saveAs);
                this.currentSaveAs = saveAs;

                document.getElementById('saveAsContainer').style.display = 'block';
                this.log('ğŸ“‹ æ–‡ä»¶ä¿å­˜å™¨å·²æ˜¾ç¤º');
            }

            // å…³é—­æ–‡ä»¶ä¿å­˜å™¨
            closeSaveAs() {
                if (this.currentSaveAs) {
                    this.currentSaveAs.remove();
                    this.currentSaveAs = null;
                }
                document.getElementById('saveAsContainer').style.display = 'none';
                this.log('âŒ æ–‡ä»¶ä¿å­˜å™¨å·²å…³é—­');
            }

            // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
            showStatus(message, type = 'info') {
                const container = document.getElementById('statusContainer');
                const status = document.createElement('div');
                status.className = `status ${type}`;
                status.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                container.appendChild(status);
                
                if (container.children.length > 5) {
                    container.removeChild(container.firstChild);
                }
            }

            // å¯¼å‡ºæ—¥å¿—
            exportLog() {
                const logContent = this.debugLog.textContent;
                const blob = new Blob([logContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `home-test-log-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.showStatus('æ—¥å¿—å·²å¯¼å‡º', 'success');
            }

            // æ—¥å¿—è®°å½•æ–¹æ³•
            log(message, data = null, level = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const elapsed = ((Date.now() - this.initStartTime) / 1000).toFixed(2);
                
                let icon = 'â„¹ï¸';
                switch (level) {
                    case 'success': icon = 'âœ…'; break;
                    case 'error': icon = 'âŒ'; break;
                    case 'warning': icon = 'âš ï¸'; break;
                }
                
                let logEntry = `[${timestamp}] [+${elapsed}s] [${level.toUpperCase()}] ${icon} ${message}`;
                
                if (data) {
                    logEntry += '\n' + JSON.stringify(data, null, 2);
                }
                
                this.debugLog.textContent += logEntry + '\n\n';
                
                if (this.autoScroll) {
                    this.debugLog.scrollTop = this.debugLog.scrollHeight;
                }
                
                // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
                console.log(`[HomeTest] ${message}`, data);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨æµ‹è¯•å™¨
        window.addEventListener('DOMContentLoaded', () => {
            new EnhancedHomeDirectoryTester();
        });
    </script>
</body>
</html>